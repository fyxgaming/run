/*! For license information please see run.node.min.js.LICENSE */
module.exports=function(t){var e={};function o(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=t,o.c=e,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=1)}([function(t,e,o){"use strict";var n=o(9),r=o(30),s=Object.prototype.toString;function i(t){return"[object Array]"===s.call(t)}function a(t){return null!==t&&"object"==typeof t}function c(t){return"[object Function]"===s.call(t)}function u(t,e){if(null!=t)if("object"!=typeof t&&(t=[t]),i(t))for(var o=0,n=t.length;o<n;o++)e.call(null,t[o],o,t);else for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.call(null,t[r],r,t)}t.exports={isArray:i,isArrayBuffer:function(t){return"[object ArrayBuffer]"===s.call(t)},isBuffer:r,isFormData:function(t){return"undefined"!=typeof FormData&&t instanceof FormData},isArrayBufferView:function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&t.buffer instanceof ArrayBuffer},isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isObject:a,isUndefined:function(t){return void 0===t},isDate:function(t){return"[object Date]"===s.call(t)},isFile:function(t){return"[object File]"===s.call(t)},isBlob:function(t){return"[object Blob]"===s.call(t)},isFunction:c,isStream:function(t){return a(t)&&c(t.pipe)},isURLSearchParams:function(t){return"undefined"!=typeof URLSearchParams&&t instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:u,merge:function t(){var e={};function o(o,n){"object"==typeof e[n]&&"object"==typeof o?e[n]=t(e[n],o):e[n]=o}for(var n=0,r=arguments.length;n<r;n++)u(arguments[n],o);return e},deepMerge:function t(){var e={};function o(o,n){"object"==typeof e[n]&&"object"==typeof o?e[n]=t(e[n],o):e[n]="object"==typeof o?t({},o):o}for(var n=0,r=arguments.length;n<r;n++)u(arguments[n],o);return e},extend:function(t,e,o){return u(e,(function(e,r){t[r]=o&&"function"==typeof e?n(e,o):e})),t},trim:function(t){return t.replace(/^\s*/,"").replace(/\s*$/,"")}}},function(t,e,o){const n=o(2),r=o(6),s=o(24),{Transaction:i}=o(8),util=o(3),{Purse:a}=o(25),c=o(26),{BlockchainServer:u}=o(27),h=o(58),{StateCache:l}=o(59),{PrivateKey:f}=n;class d{constructor(t={}){this.logger=function(t){switch(typeof t){case"object":t=t||{};break;case"undefined":t={warn:console.warn,error:console.error};break;default:throw new Error(`Option 'logger' must be an object. Received: ${t}`)}return t={...t},["info","debug","warn","error"].forEach(e=>{t[e]=t[e]||(()=>{})}),t}(t.logger),this.blockchain=function(t,e,o){switch(typeof t){case"object":if(!t)throw new Error("Option 'blockchain' must not be null");if("function"!=typeof t.broadcast)throw new Error("Blockchain requires a broadcast method");if("function"!=typeof t.fetch)throw new Error("Blockchain requires a fetch method");if("function"!=typeof t.utxos)throw new Error("Blockchain requires a utxos method");if("string"!=typeof t.network)throw new Error("Blockchain requires a network string");return t;case"string":case"undefined":{const n=d.instance?d.instance.blockchain.cache:null;return"mock"===e?new h({cache:n}):new u({network:e,cache:n,api:t,logger:o})}default:throw new Error(`Option 'blockchain' must be an object or string. Received: ${t}`)}}(t.blockchain,t.network,this.logger),function(t){n.Networks.defaultNetwork=util.bsvNetwork(t);const e=n.Transaction.prototype.sign;n.Transaction.prototype.sign=function(...t){const o=n.Transaction.Input.prototype.isValidSignature;n.Transaction.Input.prototype.isValidSignature=()=>!0;const r=e.call(this,...t);return n.Transaction.Input.prototype.isValidSignature=o,r}}(this.blockchain.network),this.app=function(t){switch(typeof t){case"string":return t;case"undefined":return"";default:throw new Error(`Option 'app' must be a string. Received: ${t}`)}}(t.app),this.state=function(t){switch(typeof t){case"object":if(!t)throw new Error("Option 'state' must not be null");if("function"!=typeof t.get)throw new Error("State requires a get method");if("function"!=typeof t.set)throw new Error("State requires a set method");return t;case"undefined":return d.instance&&d.instance.state?d.instance.state:new l;default:throw new Error(`Option 'state' must be an object. Received: ${t}`)}}(t.state),this.owner=function(t,e,o,n){switch(typeof t){case"string":case"object":case"undefined":return new c(t,{network:e,logger:o,run:n});default:throw new Error(`Option 'owner' must be a valid key or address. Received: ${t}`)}}(t.owner,this.blockchain.network,this.logger,this),this.purse=function(t,e,o){switch(typeof t){case"string":return new a({privkey:t,blockchain:e,logger:o});case"undefined":return new a({blockchain:e,logger:o});case"object":if(!t||t instanceof f)return new a({privkey:t,blockchain:e,logger:o});if("function"!=typeof t.pay)throw new Error("Purse requires a pay method");return t;default:throw new Error(`Option 'purse' must be a valid private key or Pay API. Received: ${t}`)}}(t.purse,this.blockchain,this.logger),this.code=function(t,e){switch(typeof t){case"object":if(t&&t instanceof r)return t;break;case"undefined":if(d.instance){if(d.instance.code.sandbox.toString()===e.toString())return d.instance.code}return new r(e)}throw new Error("Option 'code' must be an instance of Code")}(t.code,function(t){switch(typeof t){case"boolean":return t;case"object":if(t&&t instanceof RegExp)return t;throw new Error(`Invalid option 'sandbox'. Received: ${t}`);case"undefined":return!0;default:throw new Error(`Option 'sandbox' must be a boolean or RegExp. Received: ${t}`)}}(t.sandbox)),this.aaqc=new s(this),this.transaction=new i(this),this.loadQueue=new util.aadd,this.activate(),this.blockchain instanceof h&&this.blockchain.fund(this.purse.address,1e8)}async load(t,e={}){return this.aab(),e.childLoad?this.transaction.load(t,e):this.loadQueue.enqueue(()=>this.transaction.load(t,e))}async deploy(t){return this.aab(),this.code.deploy(t),await this.sync(),t.location}async sync(){return this.owner.sync()}activate(){return d.instance=this,n.Networks.defaultNetwork=util.bsvNetwork(this.blockchain.network),this.code.activate(this.blockchain.network),this}aab(){if(d.instance!==this){throw new Error(`This Run instance is not active\n\n${"Hint: Call run.activate() on this instance first"}`)}}}d.version="0.3.13",d.protocol=util.aacd,d.aaxb=util,d.BlockchainServer=u,d.Code=r,d.Mockchain=h,d.StateCache=l;const p={configurable:!0,enumerable:!0};Object.defineProperty(d,"Jig",{...p,get:()=>o(7)}),Object.defineProperty(d,"Token",{...p,get:()=>o(60)}),Object.defineProperty(d,"expect",{...p,get:()=>o(21)}),Object.defineProperty(global,"Jig",{...p,get:()=>d.Jig}),Object.defineProperty(global,"Token",{...p,get:()=>d.Token}),t.exports=d},function(t,e){t.exports=require("bsv")},function(t,e,o){const n=o(2);function r(t){if(!(t.outputs.length&&t.outputs[0].script.isSafeDataOut()&&7===t.outputs[0].script.chunks.length&&"run"===t.outputs[0].script.chunks[2].buf.toString("utf8")))throw new Error(`not a run tx: ${t.hash}`);if(!(1===t.outputs[0].script.chunks[3].buf.length&&1===t.outputs[0].script.chunks[3].buf[0])){const e="Hint: Are you trying to load jigs created by a different version of run? This is not possible in the private alpha, sorry.";throw new Error(`Unsupported run protocol in tx: ${t.hash}\n\n${e}`)}}function s(t){return"function"==typeof t&&(/^class [A-Za-z0-9_]/.test(t.toString())||/^function [A-Za-z0-9_]/.test(t.toString()))&&-1===t.toString().indexOf("[native code]")}const i=" abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ`1234567890-=~!@#$%^&*()_+,./;'[]\\<>?:\"{}|".split(""),a="t08sY]m'#$Dy1`}pCKrHG)f9[uq%3\\ha=!ZVMkJ-*L\"xz67R? W~@wdO:Ecg|ITe52.+{ovBj>(&,/Q4lA;^<NPnXSFi_Ub".split("");function c(t){const e=t.split("").map(t=>-1!==a.indexOf(t)?i[a.indexOf(t)]:t).join("");try{return JSON.parse(e)}catch(t){throw new Error(`unable to parse decrypted run data\n\n${t.toString()}\n\n${e}`)}}function u(){const t=o(1);if(!t.instance)throw new Error("Run not instantiated");return t.instance}t.exports={aacd:1,aac:function(t){if("string"!=typeof t)throw new Error("owner must be a pubkey string");try{new n.PublicKey(t)}catch(t){throw new Error(`owner is not a valid public key\n\n${t}`)}},aad:function(t){if("number"!=typeof t)throw new Error("satoshis must be a number");if(!Number.isInteger(t))throw new Error("satoshis must be an integer");if(isNaN(t)||!isFinite(t))throw new Error("satoshis must be finite");if(t<0)throw new Error("satoshis must be non-negative");if(t>1e8)throw new Error(`satoshis must be less than ${1e8}`)},aae:r,aaf:function(t){return r(t),c(t.outputs[0].script.chunks[5].buf.toString("utf8"))},aag:function(t,e){try{r(t)}catch(t){return"other"}if(0===e)return"rundata";const o=t.outputs[0].script.chunks[5].buf.toString("utf8");try{const t=c(o);if(e>=1&&e<1+t.code.length)return"code";if(e>=1+t.code.length&&e<1+t.code.length+t.jigs)return"jig"}catch(t){}return"other"},aah:function(t){const e=t.toString(),o=Object.getPrototypeOf(t);if(o.prototype){const n=/^class \S+ extends \S+ {/;return e.replace(n,`class ${t.name} extends ${o.name} {`)}return e},aai:s,aaj:function(t){return JSON.stringify(t).split("").map(t=>-1!==i.indexOf(t)?a[i.indexOf(t)]:t).join("")},aak:c,aal:function t(e,o=[],n=null,r=null,s=[null]){switch(typeof e){case"undefined":return{$class:"undefined"};case"string":case"boolean":return e;case"number":if(isNaN(e)||!isFinite(e))throw new Error(`${e} cannot be serialized to json`);return e;case"symbol":throw new Error(`${e.toString()} cannot be serialized to json`)}if(null===e)return null;for(const t of o){const o=t(e,n,r);if(void 0!==o)return o}if("function"==typeof e)throw new Error(`${e} cannot be serialized to json`);if(-1!==s.indexOf(e))throw new Error(`circular reference detected: ${r}`);const i=Object.getPrototypeOf(Object.getPrototypeOf(e)),a=null===i,c=Array.isArray(e)&&null===Object.getPrototypeOf(i);if(a||c){const n=a?{}:[];return s.push(e),Object.keys(e).forEach(r=>{if(r.startsWith("$"))throw new Error("$ properties must not be defined");n[r]=t(e[r],o,n,r,s)}),s.pop(),n}const h=u().code.aayb.Uint8Array;if(e.constructor===h||e.constructor===Uint8Array)return{$class:"Uint8Array",base64Data:Buffer.from(e).toString("base64")};const l=e.constructor.name?e.constructor.name:e.toString();throw new Error(`${l} cannot be serialized to json`)},aam:function t(e,o=[],n=null,r=null,s=[null]){switch(typeof e){case"undefined":throw new Error("JSON should not contain undefined");case"string":case"boolean":return e;case"number":if(isNaN(e)||!isFinite(e))throw new Error(`JSON should not contain ${e}`);return e;case"function":throw new Error(`JSON should not contain ${e}`);case"symbol":throw new Error(`JSON should not contain ${e.toString()}`)}if(null===e)return null;if(-1!==s.indexOf(e))throw new Error(`circular reference detected: ${r}`);for(const t of o){const o=t(e,n,r);if(void 0!==o)return o}if("Uint8Array"===e.$class){return new(0,u().code.aayb.Uint8Array)(Buffer.from(e.base64Data,"base64"))}if("undefined"===e.$class)return;const i=Object.getPrototypeOf(Object.getPrototypeOf(e)),a=null===i,c=Array.isArray(e)&&null===Object.getPrototypeOf(i);if(a||c){const n=a?{}:[];return s.push(e),Object.keys(e).forEach(r=>{if(r.startsWith("$"))throw new Error("$ properties must not be defined");n[r]=t(e[r],o,n,r,s)}),s.pop(),n}const h=e.constructor.name?e.constructor.name:e.toString();throw new Error(`JSON should not contain ${h}`)},aan:function(t){const{Jig:Jig}=o(1);return(e,o,n)=>{if(e instanceof Jig||s(e))return t.push(e),{$index:t.length-1}}},aao:function(t){return e=>{if(void 0!==e.$index)return t[e.$index]}},aap:function t(e,o=[],n=null,r=null,s=new Set){Array.isArray(o)?o.forEach(t=>t(e,n,r)):o(e,n,r),"object"==typeof e&&e&&!s.has(e)&&(s.add(e),Object.keys(e).forEach(n=>{t(e[n],o,e,n,s)}))},aaq:u,aar:function(t,e){return t===e||t.origin&&"_"!==t.origin[0]&&t.origin===e.origin},aas:function(t){switch(t){case"main":return"Mainnet";case"test":return"Testnet";case"stn":return"Stn";case"mock":return"Mocknet";default:throw new Error(`Unknown network: ${t}`)}},bsvNetwork:function(t){return"main"===t?"mainnet":"testnet"},aadd:class{constructor(){this.tasks=[]}async enqueue(t){return new Promise((e,o)=>{this.tasks.push({func:t,reject:o,resolve:e}),1===this.tasks.length&&this.execNext()})}async execNext(){const t=this.tasks[0];try{const e=t.func();t.resolve(e instanceof Promise?await e:e)}catch(e){t.reject(e)}finally{this.tasks.shift(),this.tasks.length&&this.execNext()}}}}},function(t,e,o){"use strict";var n=o(0);function r(t){return encodeURIComponent(t).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}t.exports=function(t,e,o){if(!e)return t;var s;if(o)s=o(e);else if(n.isURLSearchParams(e))s=e.toString();else{var i=[];n.forEach(e,(function(t,e){null!=t&&(n.isArray(t)?e+="[]":t=[t],n.forEach(t,(function(t){n.isDate(t)?t=t.toISOString():n.isObject(t)&&(t=JSON.stringify(t)),i.push(r(e)+"="+r(t))})))})),s=i.join("&")}if(s){var a=t.indexOf("#");-1!==a&&(t=t.slice(0,a)),t+=(-1===t.indexOf("?")?"?":"&")+s}return t}},function(t,e,o){"use strict";var n=o(13);t.exports=function(t,e,o,r,s){var i=new Error(t);return n(i,e,o,r,s)}},function(module,exports,__webpack_require__){const vm="undefined"==typeof window?__webpack_require__(22):__webpack_require__(23),Jig=__webpack_require__(7),util=__webpack_require__(3),bsv=__webpack_require__(2);function aadb(t){["Date","Math","eval","XMLHttpRequest","FileReader","WebSocket","setTimeout","setInterval"].forEach(e=>{void 0===t[e]&&(t[e]=void 0)})}class VMEvaluator{constructor(){this.aayb={};this.aayb.console=vm.runInContext("Object.assign(...Object.entries(c).map(([k, f]) => ({ [k]: (...a) => f(...a) })))",vm.createContext({c:console})),this.aayb.Uint8Array=vm.runInContext("Uint8Array",vm.createContext({}))}evaluate(t,e={}){if(void 0!==e.$globals)throw new Error("$globals must not be defined");aadb(e={...this.aayb,...e,$globals:{}});const o=vm.createContext(e);"undefined"==typeof window&&(o.global=o);const n=t.startsWith("class")?"AnonymousClass":"anonymousFunction",r=`with ($globals) { const ${n} = ${t}; ${n} }`;return[vm.runInContext(r,o),e.$globals]}}class GlobalEvaluator{evaluate(code,env={}){const anon=code.startsWith("class")?"AnonymousClass":"anonymousFunction";Object.keys(env).forEach(t=>{Object.defineProperty(global,t,{value:env[t],configurable:!0,enumerable:!0,writable:!0})});const result=eval(`const ${anon} = ${code}; ${anon}`);return[result,global]}}const aaed=["origin","location","originMainnet","locationMainnet","originTestnet","locationTestnet","originStn","locationStn","originMocknet","locationMocknet","owner","ownerMainnet","ownerTestnet","ownerStn","ownerMocknet"];class Code{constructor(t=!0){this.aapc=new Map,this.sandbox=t,"undefined"==typeof window||window.document.body||(window.document.body=document.createElement("body")),this.vmEvaluator=new VMEvaluator,this.globalEvaluator=new GlobalEvaluator,this.aayb=this.vmEvaluator.aayb,this.aahb()}aaeb(t){const e=this.aapc.get(t);return e&&t===e}aafb(t){return this.aaeb(t)?t:this.aapc.get(t)}static aafd(t){const e={},o=["deps",...aaed],n=Object.keys(t).filter(t=>!o.includes(t)),r=[];return n.forEach(o=>{util.aal(t[o],[util.aan(r)],null,`${t.name}.${o}`),e[o]=t[o]}),{props:e,refs:r}}deploy(t){if(t===this.Jig||t===Jig)return this.Jig;if(!util.aai(t))throw new Error(`${t} is not deployable`);const e=this.aapc.get(t),o=util.aaq(),n=util.aas(o.blockchain.network);if(e&&Object.keys(e).includes(`origin${n}`)&&Object.keys(e).includes(`location${n}`))return e;const r=Object.keys(t);if(r.includes(`location${n}`)){const e=this.aapc.get(t[`location${n}`]);if(e)return e}if(r.includes("deps")&&(s=t.deps,null!==Object.getPrototypeOf(Object.getPrototypeOf(s))))throw new Error("deps must be an object");var s;aaed.forEach(e=>{if((e=>r.includes(e)&&"string"!=typeof t[e])(e))throw new Error(`${e} must be a string: ${t[e]}`)}),o.transaction.begin();try{const e={...this.aayb},s=Object.getPrototypeOf(t),i=r.includes("deps")?{...t.deps}:{};if(s!==Object.getPrototypeOf(Object)){if(e[s.name]=this.deploy(s),i[s.name]){if(this.aafb(i[s.name])!==e[s.name])throw new Error(`unexpected parent dependency ${s.name}`)}s.name in i||s===this.aapc.get(Jig)||s===Jig||(i[s.name]=s)}const a=this.aapc.get(t);if(a&&Object.keys(a).includes(`origin${n}`)&&Object.keys(a).includes(`location${n}`))return a;const[c,u]=this.evaluate(t,util.aah(t),t.name,e,this.sandbox);this.aapc.set(t,c),this.aapc.set(c,c);const{props:h,refs:l}=Code.aafd(t);Object.keys(h).forEach(t=>{c[t]=h[t]});const f=l.filter(t=>util.aai(t));if(r.includes(`origin${n}`)||r.includes(`location${n}`))r.includes(`origin${n}`)&&(c[`origin${n}`]=c.origin=t.origin=t[`origin${n}`]),c[`location${n}`]=c.location=t.location=t[`location${n}`]||t.origin,c[`owner${n}`]=c.owner=t.owner=t[`owner${n}`],this.aapc.set(c[`location${n}`],c);else{const e=o.blockchain.network,r=r=>{o.blockchain.network===e&&(t.origin=t.location=c.origin=c.location=r,t.owner=c.owner=t[`owner${n}`]),c[`origin${n}`]=c[`location${n}`]=r,t[`origin${n}`]=t[`location${n}`]=r,this.aapc.set(r,c)},s=()=>{o.blockchain.network===e&&(delete t.origin,delete t.location,delete c.origin,delete c.location,delete t.owner,delete c.owner),delete t[`origin${n}`],delete t[`location${n}`],delete c[`origin${n}`],delete c[`location${n}`],delete t[`owner${n}`],delete c[`owner${n}`]},a=o.transaction.aamb(t,c,i,h,r,s);t[`origin${n}`]=t[`location${n}`]=a,c[`origin${n}`]=c[`location${n}`]=a,t[`owner${n}`]=c[`owner${n}`]=t.owner}return u&&Object.entries(i).forEach(([t,o])=>{if(o===s||o===e[s.name])return;Object.defineProperty(u,t,{configurable:!0,enumerable:!0,value:this.deploy(o)})}),f.forEach(t=>this.deploy(t)),Object.keys(h).forEach(t=>{this.aaad.aaac=!1,util.aap(c[t],(e,o,n)=>{const r=this.aafb(e);r&&n&&(o[n]=r),r&&!n&&(c[t]=r)}),this.aaad.aaac=!0}),Object.keys(i).length&&(c.deps={},Object.keys(i).forEach(t=>{c.deps[t]=this.deploy(i[t])})),c}finally{o.transaction.end()}}async aagb(t,e,o,n,r,s=new Map){if(this.aapc.has(e))return this.aapc.get(e);if(s.has(e))return s.get(e);const i=e.slice(0,64),a=parseInt(e.slice(66));if(o.outputs[a].script.toAddress(r).toString()!==new bsv.PublicKey(t.owner,r).toAddress().toString())throw new Error(`bad def owner: ${e}`);const c={...this.aayb};let u=null,h=null;const l=new Promise((t,e)=>{u=t,h=e});s.set(e,l);try{const r=/^class \w* extends (\w*)[\s]*{/;let a=null;if(r.test(t.text)){a=t.text.match(r)[1];let e=(t.deps||{})[a];"Jig"===a&&void 0===e?c.Jig=this.Jig:(e.startsWith("_")&&(e=o.hash+e),c[a]=await n.transaction.load(e,{partiallyInstalledCode:s}))}const h=t.text.match(/^(class|function) (\w+)[( ]/)[2],[l,f]=this.evaluate(null,t.text,h,c,this.sandbox);l.origin=l.location=e,l.owner=t.owner;const d=util.aas(n.blockchain.network);if(l[`origin${d}`]=l[`location${d}`]=e,l[`owner${d}`]=t.owner,u(l),f){const e=Object.entries(t.deps||{}).map(([t,e])=>{if(t===a)return;const r=e.startsWith("_")?o.hash+e:e;return n.transaction.load(r,{partiallyInstalledCode:s}).then(e=>{Object.defineProperty(f,t,{configurable:!0,enumerable:!0,value:e})})});await Promise.all(e)}t.deps&&(l.deps={},Object.keys(t.deps).forEach(t=>{l.deps[t]=f[t]||c[t]}));const p=[],g=(t,e,o)=>{if(void 0!==t.$ref)return p.push({location:t.$ref,parent:e,name:o}),{}},w=util.aam(t.props||{},[g]),m=t=>"i"===t[1]||"o"===t[1]?i+t:t,b=p.map(t=>n.transaction.load(m(t.location),{partiallyInstalledCode:s})),y=await Promise.all(b);if(p.forEach(({location:t,parent:e,name:o},n)=>{e[o]=y[n]}),Object.assign(l,w),s.delete(e),this.aapc.has(e)){throw new Error(`Code installed twice for ${e}\n\n${"This is an internal Run bug. Please report it to the library developers."}.`)}return this.aapc.set(e,l),this.aapc.set(l,l),l}catch(t){throw h(t),t}}aahb(){this.aaad={aabc:[],aadc:new Set,aacc:new Set,aaec:new Map,aafc:new Map,error:null,aaac:!0,aazb:new Map,aagc:new WeakMap};const t={...this.aayb,aaad:this.aaad,util:util};this.Jig=this.evaluate(Jig,Jig.toString(),"Jig",t,this.shouldSandbox("Jig"))[0],this.aapc.set(Jig,this.Jig),this.aapc.set(this.Jig,this.Jig)}shouldSandbox(t){return this.sandbox instanceof RegExp?this.sandbox.test(t):this.sandbox}evaluate(t,e,o,n,r){const s=this.aapc.get(t);if(s)return[s,null];const i=(r=r instanceof RegExp?r.test(o):r)?this.vmEvaluator:this.globalEvaluator,[a,c]=i.evaluate(e,n);return Object.defineProperty(c,"caller",{configurable:!0,enumerable:!0,get:()=>this.aaad.aabc.length<2?null:this.aaad.aazb.get(this.aaad.aabc[this.aaad.aabc.length-2])}),[!r&&t?t:a,c]}activate(t){const e=util.aas(t);this.aapc.forEach((t,o)=>{"string"!=typeof o&&(void 0!==o[`origin${e}`]?(o.origin=o[`origin${e}`],t.origin=o[`origin${e}`]):(delete o.origin,delete t.origin),void 0!==o[`location${e}`]?(o.location=o[`location${e}`],t.location=o[`location${e}`]):(delete o.location,delete t.location),void 0!==o[`owner${e}`]?(o.owner=o[`owner${e}`],t.owner=o[`owner${e}`]):(delete o.owner,delete t.owner))})}flush(){this.aapc=new Map,this.aapc.set(Jig,this.Jig),this.aapc.set(this.Jig,this.Jig)}}module.exports=Code},function(t,e,o){const util=o(3);t.exports=class Jig{constructor(...t){const e=util.aaq();if(!e.code.aaeb(this.constructor)){e.transaction.begin();try{return new(e.code.deploy(this.constructor))(...t)}finally{e.transaction.end()}}const o=[];let n=this.constructor;for(;n!==Jig;)o.push(n),n=Object.getPrototypeOf(n);if(0===o.length)throw new Error("Jig must be extended");const r=/\s+constructor\s*\(/;if(o.some(t=>r.test(t.toString())))throw new Error("Jig must use init() instead of constructor()");const s=["origin","location","owner","satoshis","sync"];o.forEach(t=>{s.forEach(t=>{if(Object.prototype.hasOwnProperty.call(o[0].prototype,t))throw new Error(`must not override ${t}`)})});const i=[];[...o,Jig].forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(t=>i.push(t))});const a=[...i,"owner","satoshis","origin","location"];function c(){aaad.aabc=[],aaad.aadc=new Set,aaad.aacc=new Set,aaad.aaec=new Map,aaad.aafc=new Map,aaad.aazb=new Map,aaad.aaac=!0,aaad.error=null}const u=()=>{if(aaad.aaac&&this.origin&&"!"===this.origin[0])throw new Error(`${this.origin.slice(1)}`)},h=this,l={parent:null,name:null},f=new Proxy(this,l),d=()=>aaad.aabc[aaad.aabc.length-1],p=()=>aaad.aabc.length&&d()===h,g=()=>aaad.aabc.length&&d().constructor!==f.constructor;let w=!!aaad.stateToInject;return l.getPrototypeOf=function(t){return u(),aaad.aabc.length&&aaad.aazb.set(h,f),Object.getPrototypeOf(t)},l.setPrototypeOf=function(t,e){throw new Error("setPrototypeOf disallowed")},l.isExtensible=function(t){return!0},l.preventExtensions=function(t){throw new Error("preventExtensions disallowed")},l.getOwnPropertyDescriptor=function(t,e){if(u(),aaad.aabc.length&&aaad.aazb.set(h,f),!this.has(t,e))return;const o=Object.getOwnPropertyDescriptor(t,e);return o?{...o,value:this.get(t,e)}:void 0},l.defineProperty=function(t,e,o){throw new Error("defineProperty disallowed")},l.has=function(t,e){if(u(),aaad.aabc.length&&aaad.aazb.set(h,f),aaad.aaac&&"_"===e[0]&&g())throw new Error(`cannot check ${e} because it is private`);return aaad.aabc.length&&(!(t instanceof Jig)||!a.includes(e))&&aaad.aacc.add(h),e in t},l.get=function(t,e,o){if(u(),aaad.aabc.length&&aaad.aazb.set(h,f),"$object"===e)return f;const n=t instanceof Jig;if(aaad.aaac&&n&&["origin","location"].includes(e)&&"_"===t[e][0])throw new Error(`sync required before reading ${e}`);if(n&&["origin","constructor"].includes(e))return t[e];const r=n&&"function"==typeof t[e];if(aaad.aabc.length&&!r&&aaad.aacc.add(h),"_"===e[0]&&g())throw new Error(`cannot get ${e} because it is private`);return["undefined","boolean","number","string","symbol"].includes(typeof t[e])?t[e]:e===Symbol.iterator?t[e].bind(t):"object"==typeof t[e]?null===t[e]?null:t[e]instanceof Jig?t[e]:aaad.aaac?new Proxy(t[e],{...this,parent:t,name:e}):t[e]:"constructor"===e?t[e]:"function"==typeof t[e]?!util.aai(t[e])||n&&i.includes(e)?new Proxy(t[e],{...this,parent:t,name:e}):t[e]:void 0},l.set=function(t,e,o,n){if(u(),aaad.aabc.length&&aaad.aazb.set(h,f),aaad.aaac){if(!p())throw new Error(`must not set ${e} outside of a method`);if(t instanceof Jig){if(["origin","location",...i].includes(e))throw new Error(`must not set ${e}`)}else{if("function"==typeof t[e])throw new Error(`must not overwrite internal method ${e}`);if("function"==typeof t)throw new Error(`must not set ${e} on method ${t.name}`)}}return t[e]=o,!0},l.deleteProperty=function(t,e){if(u(),aaad.aabc.length&&aaad.aazb.set(h,f),aaad.aaac){if(!p())throw new Error(`must not delete ${e} outside of a method`);if(t instanceof Jig){if(["origin","location",...i].includes(e))throw new Error(`must not delete ${e}`)}else if("function"==typeof t[e])throw new Error(`must not delete internal method ${e}`)}return delete t[e],!0},l.ownKeys=function(t){return u(),aaad.aabc.length&&aaad.aazb.set(h,f),aaad.aabc.length&&aaad.aacc.add(h),g()?Reflect.ownKeys(t).filter(t=>"_"!==t[0]):Reflect.ownKeys(t)},l.apply=function(t,e,o){const n=this.parent instanceof Jig;if(n&&"_"===this.name[0]&&(!aaad.aabc.length||d().constructor!==f.constructor))throw new Error(`cannot call ${this.name} because it is private`);if(n&&"sync"===this.name){if(aaad.aabc.length)throw new Error("sync may only be called externally");return t.call(f,...o)}const r=util.aaq();r.transaction.begin();let s=null;n||p()||(s={...aaad},c());const i=aaad.aafc.get(h)||new Set;aaad.aabc.forEach(t=>i.add(t)),aaad.aafc.set(h,i),aaad.aabc.push(h),aaad.aazb.set(h,f);try{if(n&&"init"===this.name){if(w)throw new Error("init cannot be called twice");w=!0,aaad.aadc.add(h)}const e=new Set(aaad.aacc);aaad.aaac=!1;const i=[],a=t=>{util.aai(t)&&r.code.deploy(t)},u=[a,util.aan(i)],l=n?util.aal(o,u):null;if(!aaad.aaec.has(h)){const t={refs:[]},e=[a,util.aan(t.refs)];t.json=util.aal({...h},e),aaad.aaec.set(h,t)}aaad.aaac=!0,aaad.aacc=e;const d=n?util.aam(l,[util.aao(i)]):o,p=t.call(n?f:this.parent,...d);if(n&&"init"===this.name&&void 0!==p)throw new Error("init must not return");if(n&&(util.aac(h.owner),util.aad(h.satoshis)),aaad.error)throw new Error(`internal errors must not be swallowed\n\n${aaad.error}`);if(aaad.aabc.pop(),!aaad.aabc.length){const t=new Set(aaad.aacc);aaad.aaac=!1;const e=(t,e,o)=>{if(void 0!==t.$object&&t.$object!==f){throw new Error(`property ${o} is owned by a different jig\n\n${`Hint: Consider saving a clone of ${o}'s value instead.`}`)}},i=new Map,a=new Set(aaad.aacc);Array.from(aaad.aaec.keys()).forEach(t=>a.add(t)),a.forEach(t=>{const o=[],n=[util.aan(o),e],r=util.aal({...t},n);i.set(t,{json:r,refs:o})});const u=[];for(const[t,e]of aaad.aaec){const o=i.get(t),n=(t,e)=>t!==o.refs[e];(JSON.stringify(e.json)!==JSON.stringify(o.json)||e.refs.some(n))&&u.push(t)}if(aaad.aaac=!0,aaad.aacc=t,aaad.aadc.size||u.length){if(!n)throw new Error(`internal method ${this.name} may not be called to change state`);const t=new Set,e=new Set,s=new Set(aaad.aacc),a=o=>{e.add(o),aaad.aadc.has(o)||t.add(o)};u.forEach(t=>{aaad.aafc.get(t).forEach(t=>a(t)),a(t)}),aaad.aadc.forEach(t=>{aaad.aafc.get(t).forEach(t=>a(t)),a(t)}),r.transaction.aanb(h,this.name,o,t,e,s,aaad.aaec,i,aaad.aazb)}s?(aaad.aadc.forEach(t=>s.aadc.add(t)),aaad.aacc.forEach(t=>s.aacc.add(t)),aaad.aaec.forEach((t,e)=>{aaad.aaec.has(e)||s.aaec.set(e,t)}),aaad.aazb.forEach((t,e)=>{aaad.aazb.has(e)||s.aazb.set(e,t)}),aaad.aafc.forEach((t,e)=>{aaad.aafc.has(e)?t.forEach(t=>s.get(e).add(t)):s.aafc.set(e,t)}),Object.assign(aaad,s)):c()}return r.transaction.end(),p}catch(t){aaad.error||(aaad.error=t),s&&Object.assign(aaad,s),aaad.aabc.pop(),aaad.aabc.length||(aaad.aaec.forEach((t,e)=>{Object.keys(e).forEach(t=>delete e[t]),Object.assign(e,util.aam(t.json,[util.aao(t.refs)]))}),c()),r.transaction.end();const e=t.toString();if("TypeError: Date is not a constructor"===e){throw new Error(`${e}\n\n${"Hint: Date is disabled inside jigs because it is non-deterministic."}\n${"Consider passing in the Date as a number instead."}`)}throw t}},aaad.stateToInject?(Object.assign(this,aaad.stateToInject),f):(this.owner=aaad.aabc.length?aaad.aabc[aaad.aabc.length-1].owner:e.transaction.owner,this.satoshis=0,this.origin="_",this.location="_",f.init(...t),f)}init(){}toString(){return`[jig ${this.constructor.name}]`}sync(t){return util.aaq().aaqc.sync({...t,target:this})}static[Symbol.hasInstance](t){const e=util.aaq();if("object"!=typeof t||!("location"in t))return!1;let o=e.code.aafb(this);if(!o){const t=util.aas(e.blockchain.network);if(o=e.code.aafb(this[`origin${t}`]),!o)return!1}let n=Object.getPrototypeOf(t);for(;n;){if(n===o.prototype)return!0;n=Object.getPrototypeOf(n)}return!1}}},function(t,e,o){const n=o(2),util=o(3),r=o(6);class s{constructor(t){this.aagd=t,this.reset()}reset(){this.code=[],this.actions=[],this.stateBefore=new Map,this.stateAfter=new Map,this.inputs=[],this.outputs=[],this.aacc=new Set,this.aazb=new Map,this.locations=new Map,this.aasc=0,this.imported=!1}async import(t,e,s,i,a,c){if(this.code.length||this.code.actions||this.aasc)throw new Error("transaction already in progress. cannot import.");for(let o=0;o<t.inputs.length;o++){const r=t.inputs[o];if(!r.output){const t=await e.blockchain.fetch(r.prevTxId.toString("hex"));if(!t.outputs[r.outputIndex].script.isPublicKeyHashOut())throw new Error(`Unsupported script type at input ${o}`);r.output=t.outputs[r.outputIndex],Reflect.setPrototypeOf(r,n.Transaction.Input.PublicKeyHash.prototype)}}this.aasc=1,this.imported=!0;const u=util.aaf(t),h=util.bsvNetwork(e.blockchain.network);let l=1;for(const o of u.code){const n=`${t.hash}_o${l++}`;await e.code.aagb(o,n,t,e,h,c)}if(a&&a>0&&a<1+u.code.length)return void(this.code=new Array(u.code.length));const f=new Map;u.refs&&u.refs.forEach(t=>f.set(t,t));for(const e of u.actions){const o=e=>{if("_"!==e[0]&&f.set(e,e),"i"===e[1]){const o=t.inputs[parseInt(e.slice(2))];f.set(e,`${o.prevTxId.toString("hex")}_o${o.outputIndex}`)}};e.target&&"init"!==e.method&&o(e.target);const n=t=>{t&&void 0!==t.$ref&&o(t.$ref)};util.aap(e.args,n)}for(const[,o]of f){const n=await e.blockchain.fetch(o.slice(0,64)),r=parseInt(o.slice(66));if(void 0===n.outputs[r].spentTxId)throw new Error("Cannot check if read is stale. Blockchain API does not support spentTxId.");if(null===n.outputs[r].spentTxId)continue;const s=await e.blockchain.fetch(n.outputs[r].spentTxId);if(s.time<=t.time&&s.time>=n.time&&t.time-n.time>72e5&&t.hash!==s.hash)throw new Error(`${o} is stale. Aborting.`)}for(const[t,o]of f)if(s&&o===s.location)f.set(t,s);else try{f.set(t,await e.load(o,{childLoad:!0}))}catch(n){throw e.logger.error(n),new Error(`Error loading ref ${t} at ${o}\n\n${n}`)}const{Jig:Jig}=o(1),d=t=>{e.code.aaad.aaac=!1;util.aap(t,(t,e,o)=>{if(t&&t instanceof Jig){if(!e)return;const n=Array.from(f.values()).find(e=>e.origin===t.origin);n&&(e[o]=n)}}),e.code.aaad.aaac=!0};for(const t of f.values())d(t);for(const o of u.actions){const n=t=>{if(void 0!==t.$ref){if("_"!==t.$ref[0]||"i"===t.$ref[1]){const e=f.get(t.$ref);if(!e)throw new Error(`unexpected ref ${t.$ref}`);return e}if("r"===t.$ref[1]){const e=f.get(u.refs[parseInt(t.$ref.slice(2))]);if(!e)throw new Error(`unexpected ref ${t.$ref}`);return e}if("o"!==t.$ref[1])throw new Error(`unexpected ref ${t.$ref}`);const e=parseInt(t.$ref.slice(2))-1-u.code.length;return this.aazb.get(this.outputs[e])}};e.code.aaad.aaac=!1;const r=util.aam(o.args,[n]);if(e.code.aaad.aaac=!0,"init"===o.method){if("_"===o.target[0]){const t=parseInt(o.target.slice(2));if(t<=0||t>=u.code.length+1)throw new Error(`missing target ${o.target}`)}const n="_"===o.target[0]?t.hash+o.target:o.target,s=await e.load(n,{childLoad:!0}),i=e.transaction.aaob(this,o.creator);try{new s(...r)}finally{e.transaction.aaob(i.aarc,i.creator)}}else{const t=f.get(o.target)||this.aazb.get(this.outputs[parseInt(o.target.slice(2))-1-u.code.length]);if(d(t),void 0===t)throw new Error(`target ${o.target} missing`);const n=e.transaction.aaob(this,null);try{t[o.method](...r)}catch(t){throw new Error(`unexpected exception in ${o.method}\n\n${t}`)}finally{e.transaction.aaob(n.aarc,n.creator)}}}const p=this.inputs.filter(t=>"_"!==t.origin[0]);if(u.jigs!==this.outputs.length)throw new Error("bad number of jigs");if(t.inputs.length<p.length)throw new Error("not enough inputs");if(t.outputs.length<u.code.length+u.jigs+1)throw new Error("not enough outputs");p.forEach((e,o)=>{if(`${t.inputs[o].prevTxId.toString("hex")}_o${t.inputs[o].outputIndex}`!==(this.locations.get(e.origin)||e.location))throw new Error(`bad input ${o}`)}),this.outputs.forEach((e,o)=>{const r=1+u.code.length+o;if(new n.PublicKey(e.owner,{network:h}).toAddress().toString()!==t.outputs[r].script.toAddress(h).toString())throw new Error(`bad owner on output ${r}`);if(t.outputs[r].satoshis<Math.max(e.satoshis,n.Transaction.DUST_AMOUNT))throw new Error(`bad satoshis on output ${r}`)}),i&&this.outputs.forEach(e=>{const o=`${t.hash}_o${1+u.code.length+parseInt(e.location.slice(2))}`;"_"===e.origin[0]&&(e.origin=o),"_"===e.location[0]&&(e.location=o)});const g=this.outputs.map(t=>this.aazb.get(t)),w=new Array(1+u.code.length).concat(g),m=util.aas(e.blockchain.network);for(let o=0;o<w.length;o++){if(!w[o])continue;const n=`${t.hash.slice(0,64)}_o${o}`;e.code.aaad.aaac=!1;const r=util.aal({...w[o]},[e=>{if(e instanceof Jig||util.aai(e))return e.location.startsWith(t.hash)?{$ref:e.location.slice(64)}:{$ref:e.location}}]);e.code.aaad.aaac=!0,r.origin.startsWith(t.hash)&&delete r.origin,r.location.startsWith(t.hash)&&delete r.location;let s=w[o].constructor[`origin${m}`];s.startsWith(t.hash)&&(s=s.slice(64));const i={type:s,state:r};await e.state.set(n,i)}this.code=[],u.code.forEach((o,n)=>{const s=`${t.hash}_o${n+1}`,i=e.code.aafb(s);this.aamb(i,i,{},r.aafd(i).props,()=>{},()=>{},o.owner,e.code,e)});const b=p.map(t=>this.locations.get(t.origin)||t.location);this.aatc={tx:t,refs:u.refs||[],aahd:p,aaid:b}}begin(){this.aasc++}end(){if(0===this.aasc)throw new Error("end transaction without begin");0==--this.aasc&&this.aagd&&(this.code.length||this.actions.length)&&this.aagd()}rollback(t,e,o,n){delete this.aatc,this.code.forEach(t=>t.error()),this.code.forEach(t=>e.owner.aavb(t.sandbox)),this.outputs.forEach(e=>{if("_"===e.origin[0]||n){const t=`!${"_"===e.origin[0]?"deploy failed":"a previous update failed"}\n\n${o}`;return Object.keys(e).forEach(t=>delete e[t]),void(e.origin=e.location=t)}if("_"!==e.location[0])return;const r=e.origin;Object.keys(e).forEach(t=>delete e[t]);const s=util.aao(this.stateBefore.get(e).refs);Object.assign(e,util.aam(this.stateBefore.get(e).json,[s])),e.origin=r,e.location=t.get(r)}),this.outputs.forEach(t=>e.owner.aavb(this.aazb.get(t))),this.reset()}aamb(t,e,o,n,r,s,i,a,c){delete this.aatc,this.begin();try{this.code.push({type:t,sandbox:e,deps:o,props:n,success:r,error:s,owner:i});const u=`_d${this.code.length-1}`;return t.owner=e.owner=i,c.owner.aavb(a.aafb(t)),u}finally{this.end()}}aanb(t,e,o,n,r,s,i,a,c,u){delete this.aatc,this.begin();try{const u=new Map,h=t=>{const e=t=>void 0!==t.origin&&"_"!==t.origin[0],o=u.get(e(t)?t.origin:t);if(!o)return u.set(e(t)?t.origin:t,t.location);if(o!==t.location)throw new Error(`referenced different locations of same jig: ${t}`)};h(t),n.forEach(t=>h(t)),r.forEach(t=>h(t)),s.forEach(t=>h(t)),i.forEach((t,e)=>{this.stateBefore.set(e,this.stateBefore.get(e)||t)}),a.forEach((t,e)=>{this.stateAfter.set(e,t)}),n.forEach(t=>{if(this.inputs.some(e=>util.aar(t,e)&&e.location!==t.location))throw new Error("different instances of the same jig");this.inputs.some(e=>util.aar(t,e))||this.inputs.push(t)}),r.forEach(t=>{const e=this.outputs.findIndex(e=>util.aar(t,e));if(-1!==e)return t.location=`_o${e}`,void(t.origin=t.origin||t.location);this.outputs.push(t);(t=>t.origin&&"_"!==t.origin[0]&&t.location&&"_"!==t.location[0]&&!this.locations.has(t.origin))(t)&&this.locations.set(t.origin,t.location),t.location=`_o${this.outputs.length-1}`,t.origin=t.origin||t.location}),s.forEach(t=>this.aacc.add(t)),c.forEach((t,e)=>this.aazb.set(e,t));const l=i.get(t).json.owner;this.actions.push({target:t,method:e,creator:l,args:o,inputs:n,outputs:r,aacc:s})}finally{this.end()}r.forEach(t=>u.owner.aavb(c.get(t)))}async pay(t){return this.aatc||this.aapb(t),t.purse.pay(this.aatc.tx)}async sign(t){return this.aatc||this.aapb(t),t.owner.sign(this.aatc.tx)}aapb(t){if(this.aatc)return this.aatc;const{blockchain:e,aaqc:r}=t,s=util.aas(e.network),i=util.bsvNetwork(e.network),a=this.inputs.filter(t=>"_"!==t.origin[0]),c=new Map;this.aacc.forEach(t=>{if(a.includes(t)||this.outputs.includes(t))return;const e=r.aawc.get(t.origin)||this.locations.get(t.origin)||t.location,o=c.get(t.origin);if(o&&o!==e)throw new Error(`read different locations of same jig ${t.origin}`);c.set(t.origin,e)});const u=Array.from(c.values()),{Jig:Jig}=o(1),h=t=>{if(t instanceof Jig){const e=Array.from(this.aazb.entries()).filter(([e,o])=>o===t).map(([t,e])=>t);e.length&&(t=e[0]);const o=a.findIndex(e=>util.aar(e,t));if(-1!==o)return{$ref:`_i${o}`};const n=this.outputs.findIndex(e=>util.aar(e,t));if(-1!==n)return{$ref:`_o${1+this.code.length+n}`};const s=u.indexOf(c.get(t.origin));return-1!==s?{$ref:`_r${s}`}:{$ref:r.aawc.get(t.origin)||t.location}}},l=t=>{if(util.aai(t)){return{$ref:"_"===t[`location${s}`][0]?`_o${parseInt(t[`location${s}`].slice(2))+1}`:t[`location${s}`]}}},f=this.actions.map(t=>{const{method:e}=t,o=util.aal(t.args,[h,l]);if("init"===e){const n=t.target.constructor[`origin${s}`]||t.target.constructor[`location${s}`];return{target:"_"===n[0]?`_o${1+parseInt(n.slice(2))}`:n,method:e,args:o,creator:t.creator}}const n=a.findIndex(e=>util.aar(e,t.target));if(-1!==n)return{target:`_i${n}`,method:e,args:o};const i=this.outputs.findIndex(e=>util.aar(e,t.target));return-1!==i?{target:`_o${1+this.code.length+i}`,method:e,args:o}:{target:"_"!==t.target.location[0]?t.target.location:r.aawc.get(t.target.origin),method:e,args:o}}),d={code:this.code.map(t=>{const e=Object.entries(t.deps).map(([t,e])=>{return{[t]:(o=e[`location${s}`],"_"===o[0]?`_o${1+parseInt(o.slice(2))}`:o)};var o}),o=e.length?Object.assign(...e):void 0;let n;return Object.keys(t.props).length&&(n=util.aal(t.props,[h,l])),{text:util.aah(t.type),deps:o,props:n,owner:t.owner}}),actions:f,jigs:this.outputs.length,refs:u.length?u:void 0},p=util.aaj(d),g=Buffer.from("run","utf8"),w=Buffer.from([util.aacd],"hex"),m=Buffer.from(t.app,"utf8"),b=Buffer.from(p,"utf8"),y=Buffer.from("r11r","utf8"),x=n.Script.buildSafeDataOut([g,w,m,b,y]),v=(new n.Transaction).addOutput(new n.Transaction.Output({script:x,satoshis:0})),E=a.map(t=>r.aawc.get(t.origin)||this.locations.get(t.origin)||t.location);a.forEach((t,e)=>{const o=E[e].slice(0,64),r=parseInt(E[e].slice(66)),s=this.stateBefore.get(t),a=Math.max(n.Transaction.DUST_AMOUNT,s.json.satoshis),c=new n.PublicKey(s.json.owner,{network:i}),u={txid:o,vout:r,script:n.Script.buildPublicKeyHashOut(c),satoshis:a};v.from(u)});return this.code.forEach(t=>v.to((t=>new n.PublicKey(t.owner,{network:i}))(t),n.Transaction.DUST_AMOUNT)),this.outputs.forEach(t=>{const e=this.stateAfter.get(t).json.owner,o=new n.PublicKey(e,{network:i}).toAddress(),r=this.stateAfter.get(t).json.satoshis;v.to(o,Math.max(n.Transaction.DUST_AMOUNT,r))}),this.aatc={tx:v,refs:u,aahd:a,aaid:E},this.aatc}}t.exports={aabd:s,Transaction:class{constructor(t){this.run=t,this.aaqc=t.aaqc,this.blockchain=t.blockchain,this.state=t.state,this.owner=t.owner.pubkey?t.owner.pubkey:null,this.code=t.code,this.aarc=new s(this.aagd.bind(this))}begin(){return this.aarc.begin(),this.run}end(){return this.aarc.end(),this.run}aagd(){this.aaqc.aalb(this.aarc),this.aarc=new s(this.aagd.bind(this))}export(){if(this.aaqc.aaxc.length>0)throw new Error("must not have any queued transactions before exporting");if(0===this.aarc.aasc){throw new Error(`No transaction in progress\n\n${"Hint: A transaction must first be created using begin() or loaded using import()."}`)}return this.aarc.aapb(this.run).tx}import(t){return this.aarc.import(t,this.run,!1)}rollback(){this.aarc.rollback(this.aaqc.aawc,this.run,!1,"intentional rollback")}async sign(){await this.aarc.sign(this.run)}async pay(){await this.aarc.pay(this.run)}get actions(){return this.aarc.actions.map(t=>({target:this.aarc.aazb.get(t.target),method:t.method,args:t.args}))}aamb(t,e,o,n,r,s){return this.aarc.aamb(t,e,o,n,r,s,this.owner,this.code,this.run)}aanb(t,e,o,n,r,s,i,a,c,u){this.aarc.aanb(t,e,o,n,r,s,i,a,c,this.run)}async load(t,e={}){this.run.logger&&this.run.logger.info("Loading",t);const o=e.cachedRefs||new Map;if("string"!=typeof t)throw new Error(`typeof location is ${typeof t} - must be string`);const n=this.code.aafb(t);if(n)return n;if(e.partiallyInstalledCode&&e.partiallyInstalledCode.has(t))return e.partiallyInstalledCode.get(t);const r=t.slice(0,64);if("_"!==t[64])throw new Error(`Bad location: ${t}`);if("i"===t[65]){const e=await this.blockchain.fetch(r),o=parseInt(t.slice(66)),n=e.inputs[o].prevTxId.toString("hex");return this.load(`${n}_o${e.inputs[o].outputIndex}`)}const i=parseInt(t.slice(66));if("o"!==t[65]||isNaN(i))throw new Error(`Bad location: ${t}`);const a=await this.state.get(t);if(a){if("string"!=typeof a.type||"object"!=typeof a.state){const t="Hint: Could the state cache be corrupted?";throw new Error(`Cached state is missing a valid type and/or state property\n\n${JSON.stringify(a)}\n\n${t}`)}const e=a.type.startsWith("_")?t.slice(0,64)+a.type:a.type,n=await this.load(e),r=t=>{if(void 0!==t.$ref)return t};this.code.aaad.stateToInject=util.aam(a.state,[r]),this.code.aaad.stateToInject.origin=this.code.aaad.stateToInject.origin||t,this.code.aaad.stateToInject.location=this.code.aaad.stateToInject.location||t;const s=new n;this.code.aaad.stateToInject=null,o.set(t,s);const i=e=>e.startsWith("_")?`${t.slice(0,64)}${e}`:e;util.aap(a.state,t=>{if(t&&t.$ref){const e=i(t.$ref);o.has(e)||o.set(e,null)}});const c=new Map(o);for(const[t,e]of c){if(e)continue;const n=await this.load(t,{cachedRefs:o});o.has(t)&&o.set(t,n)}return this.code.aaad.aaac=!1,util.aap(s,(t,e,n)=>{t&&t.$ref&&(e[n]=o.get(i(t.$ref)))}),this.code.aaad.aaac=!0,s}const c=new s,u=await this.blockchain.fetch(r);if(await c.import(u,this.run,null,!0,i,e.partiallyInstalledCode),i>0&&i<c.code.length+1)return this.code.aafb(t)||e.partiallyInstalledCode.get(t);const h=c.outputs.map(t=>c.aazb.get(t)),l=new Array(1+c.code.length).concat(h);if(void 0===l[i])throw new Error("not a jig output");return l[i]}aaob(t,e){const o={aarc:this.aarc,creator:this.owner};return this.aarc=t,this.owner=e,o}}}},function(t,e,o){"use strict";t.exports=function(t,e){return function(){for(var o=new Array(arguments.length),n=0;n<o.length;n++)o[n]=arguments[n];return t.apply(e,o)}}},function(t,e,o){"use strict";t.exports=function(t){return!(!t||!t.__CANCEL__)}},function(t,e,o){"use strict";var n=o(0),r=o(35),s={"Content-Type":"application/x-www-form-urlencoded"};function i(t,e){!n.isUndefined(t)&&n.isUndefined(t["Content-Type"])&&(t["Content-Type"]=e)}var a,c={adapter:("undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process)?a=o(36):"undefined"!=typeof XMLHttpRequest&&(a=o(50)),a),transformRequest:[function(t,e){return r(e,"Accept"),r(e,"Content-Type"),n.isFormData(t)||n.isArrayBuffer(t)||n.isBuffer(t)||n.isStream(t)||n.isFile(t)||n.isBlob(t)?t:n.isArrayBufferView(t)?t.buffer:n.isURLSearchParams(t)?(i(e,"application/x-www-form-urlencoded;charset=utf-8"),t.toString()):n.isObject(t)?(i(e,"application/json;charset=utf-8"),JSON.stringify(t)):t}],transformResponse:[function(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(t){}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(t){return t>=200&&t<300}};c.headers={common:{Accept:"application/json, text/plain, */*"}},n.forEach(["delete","get","head"],(function(t){c.headers[t]={}})),n.forEach(["post","put","patch"],(function(t){c.headers[t]=n.merge(s)})),t.exports=c},function(t,e,o){"use strict";var n=o(5);t.exports=function(t,e,o){var r=o.config.validateStatus;!r||r(o.status)?t(o):e(n("Request failed with status code "+o.status,o.config,null,o.request,o))}},function(t,e,o){"use strict";t.exports=function(t,e,o,n,r){return t.config=e,o&&(t.code=o),t.request=n,t.response=r,t.isAxiosError=!0,t.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,aabc:this.aabc,config:this.config,code:this.code}},t}},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("https")},function(t,e,o){var n=o(17),r=o(14),s=o(15),i=o(37),a=o(38).Writable,c=o(39)("follow-redirects"),u={GET:!0,HEAD:!0,OPTIONS:!0,TRACE:!0},h=Object.create(null);function l(t,e){a.call(this),t.headers=t.headers||{},this._options=t,this._redirectCount=0,this._redirects=[],this._requestBodyLength=0,this._requestBodyBuffers=[],t.host&&(t.hostname||(t.hostname=t.host),delete t.host),e&&this.on("response",e);var o=this;if(this._onNativeResponse=function(t){o._processResponse(t)},!t.pathname&&t.path){var n=t.path.indexOf("?");n<0?t.pathname=t.path:(t.pathname=t.path.substring(0,n),t.search=t.path.substring(n))}this._performRequest()}function f(t){var e={maxRedirects:21,maxBodyLength:10485760},o={};return Object.keys(t).forEach((function(r){var s=r+":",a=o[s]=t[r],u=e[r]=Object.create(a);u.request=function(t,r){return"string"==typeof t?(t=n.parse(t)).maxRedirects=e.maxRedirects:t=Object.assign({protocol:s,maxRedirects:e.maxRedirects,maxBodyLength:e.maxBodyLength},t),t.nativeProtocols=o,i.equal(t.protocol,s,"protocol mismatch"),c("options",t),new l(t,r)},u.get=function(t,e){var o=u.request(t,e);return o.end(),o}})),e}["abort","aborted","error","socket","timeout"].forEach((function(t){h[t]=function(e){this._redirectable.emit(t,e)}})),l.prototype=Object.create(a.prototype),l.prototype.write=function(t,e,o){if(!("string"==typeof t||"object"==typeof t&&"length"in t))throw new Error("data should be a string, Buffer or Uint8Array");"function"==typeof e&&(o=e,e=null),0!==t.length?this._requestBodyLength+t.length<=this._options.maxBodyLength?(this._requestBodyLength+=t.length,this._requestBodyBuffers.push({data:t,encoding:e}),this._currentRequest.write(t,e,o)):(this.emit("error",new Error("Request body larger than maxBodyLength limit")),this.abort()):o&&o()},l.prototype.end=function(t,e,o){"function"==typeof t?(o=t,t=e=null):"function"==typeof e&&(o=e,e=null);var n=this._currentRequest;this.write(t||"",e,(function(){n.end(null,null,o)}))},l.prototype.setHeader=function(t,e){this._options.headers[t]=e,this._currentRequest.setHeader(t,e)},l.prototype.removeHeader=function(t){delete this._options.headers[t],this._currentRequest.removeHeader(t)},["abort","flushHeaders","getHeader","setNoDelay","setSocketKeepAlive","setTimeout"].forEach((function(t){l.prototype[t]=function(e,o){return this._currentRequest[t](e,o)}})),["aborted","connection","socket"].forEach((function(t){Object.defineProperty(l.prototype,t,{get:function(){return this._currentRequest[t]}})})),l.prototype._performRequest=function(){var t=this._options.protocol,e=this._options.nativeProtocols[t];if(e){if(this._options.agents){var o=t.substr(0,t.length-1);this._options.agent=this._options.agents[o]}var r=this._currentRequest=e.request(this._options,this._onNativeResponse);for(var s in this._currentUrl=n.format(this._options),r._redirectable=this,h)s&&r.on(s,h[s]);if(this._isRedirect){var i=0,a=this._requestBodyBuffers;!function t(){if(i<a.length){var e=a[i++];r.write(e.data,e.encoding,t)}else r.end()}()}}else this.emit("error",new Error("Unsupported protocol "+t))},l.prototype._processResponse=function(t){this._options.trackRedirects&&this._redirects.push({url:this._currentUrl,headers:t.headers,statusCode:t.statusCode});var e=t.headers.location;if(e&&!1!==this._options.followRedirects&&t.statusCode>=300&&t.statusCode<400){if(++this._redirectCount>this._options.maxRedirects)return void this.emit("error",new Error("Max redirects exceeded."));var o,r=this._options.headers;if(307!==t.statusCode&&!(this._options.method in u))for(o in this._options.method="GET",this._requestBodyBuffers=[],r)/^content-/i.test(o)&&delete r[o];if(!this._isRedirect)for(o in r)/^host$/i.test(o)&&delete r[o];var s=n.resolve(this._currentUrl,e);c("redirecting to",s),Object.assign(this._options,n.parse(s)),this._isRedirect=!0,this._performRequest(),t.destroy()}else t.responseUrl=this._currentUrl,t.redirects=this._redirects,this.emit("response",t),this._requestBodyBuffers=[]},t.exports=f({http:r,https:s}),t.exports.wrap=f},function(t,e){t.exports=require("url")},function(t,e,o){function n(t){var o;function n(){if(n.enabled){var t=n,r=+new Date,s=r-(o||r);t.diff=s,t.prev=o,t.curr=r,o=r;for(var i=new Array(arguments.length),a=0;a<i.length;a++)i[a]=arguments[a];i[0]=e.coerce(i[0]),"string"!=typeof i[0]&&i.unshift("%O");var c=0;i[0]=i[0].replace(/%([a-zA-Z%])/g,(function(o,n){if("%%"===o)return o;c++;var r=e.formatters[n];if("function"==typeof r){var s=i[c];o=r.call(t,s),i.splice(c,1),c--}return o})),e.formatArgs.call(t,i);var u=n.log||e.log||console.log.bind(console);u.apply(t,i)}}return n.namespace=t,n.enabled=e.enabled(t),n.useColors=e.useColors(),n.color=function(t){var o,n=0;for(o in t)n=(n<<5)-n+t.charCodeAt(o),n|=0;return e.colors[Math.abs(n)%e.colors.length]}(t),n.destroy=r,"function"==typeof e.init&&e.init(n),e.instances.push(n),n}function r(){var t=e.instances.indexOf(this);return-1!==t&&(e.instances.splice(t,1),!0)}(e=t.exports=n.debug=n.default=n).coerce=function(t){return t instanceof Error?t.aabc||t.message:t},e.disable=function(){e.enable("")},e.enable=function(t){var o;e.save(t),e.names=[],e.skips=[];var n=("string"==typeof t?t:"").split(/[\s,]+/),r=n.length;for(o=0;o<r;o++)n[o]&&("-"===(t=n[o].replace(/\*/g,".*?"))[0]?e.skips.push(new RegExp("^"+t.substr(1)+"$")):e.names.push(new RegExp("^"+t+"$")));for(o=0;o<e.instances.length;o++){var s=e.instances[o];s.enabled=e.enabled(s.namespace)}},e.enabled=function(t){if("*"===t[t.length-1])return!0;var o,n;for(o=0,n=e.skips.length;o<n;o++)if(e.skips[o].test(t))return!1;for(o=0,n=e.names.length;o<n;o++)if(e.names[o].test(t))return!0;return!1},e.humanize=o(41),e.instances=[],e.names=[],e.skips=[],e.formatters={}},function(t,e,o){"use strict";var n=o(0);t.exports=function(t,e){e=e||{};var o={};return n.forEach(["url","method","params","data"],(function(t){void 0!==e[t]&&(o[t]=e[t])})),n.forEach(["headers","auth","proxy"],(function(r){n.isObject(e[r])?o[r]=n.deepMerge(t[r],e[r]):void 0!==e[r]?o[r]=e[r]:n.isObject(t[r])?o[r]=n.deepMerge(t[r]):void 0!==t[r]&&(o[r]=t[r])})),n.forEach(["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"],(function(n){void 0!==e[n]?o[n]=e[n]:void 0!==t[n]&&(o[n]=t[n])})),o}},function(t,e,o){"use strict";function n(t){this.message=t}n.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},n.prototype.__CANCEL__=!0,t.exports=n},function(t,e){function expect(t){let e=!1;const o=t=>"object"==typeof t?JSON.stringify(t):t;function n(n,r,s){if(e?n:!n)throw new Error(s||`expected value${e?" not":""} to be ${r} but was ${o(t)}`)}return{get not(){return e=!e,this},toBe:(e,r)=>n(t===e,`${o(e)}`,r),toEqual:(e,r)=>n(function t(e,o){return typeof e==typeof o&&("object"==typeof e&&"object"==typeof o?Object.keys(e).length===Object.keys(o).length&&Object.keys(e).every(n=>t(e[n],o[n])):e===o)}(t,e),`equal to ${o(e)}`,r),toBeInstanceOf:(e,o)=>n(t&&t instanceof e,`an instance of ${e.name}`,o),toBeDefined:e=>n(void 0!==t,"defined",e),toBeNull:e=>n(null===t,"null",e),toBeNumber:e=>n("number"==typeof t,"a number",e),toBeInteger:e=>n(Number.isInteger(t),"an integer",e),toBeLessThan:(e,o)=>n(t<e&&"number"==typeof t&&"number"==typeof e,`less than ${e}`,o),toBeLessThanOrEqualTo:(e,o)=>n(t<=e&&"number"==typeof t&&"number"==typeof e,`less than or equal to ${e}`,o),toBeGreaterThan:(e,o)=>n(t>e&&"number"==typeof t&&"number"==typeof e,`greater than ${e}`,o),toBeGreaterThanOrEqualTo:(e,o)=>n(t>=e&&"number"==typeof t&&"number"==typeof e,`greater than or equal to ${e}`,o),toBeBoolean:e=>n("boolean"==typeof t,"a boolean",e),toBeString:e=>n("string"==typeof t,"a string",e),toBeObject:e=>n(t&&"object"==typeof t,"an object",e),toBeArray:e=>n(Array.isArray(t),"an array",e),toBeClass:e=>n("function"==typeof t&&t.toString().startsWith("class"),"a class",e),toBeFunction:e=>n("function"==typeof t&&!t.toString().startsWith("class"),"a function",e)}}expect.originTestnet="f02739791f7d54bfed43452faef4c994f87d93d33cafa4d246345358d4f96460_o1",expect.locationTestnet="f02739791f7d54bfed43452faef4c994f87d93d33cafa4d246345358d4f96460_o1",expect.ownerTestnet="020b48771735aac0b1d5362a5341f7f9ff9df9deac0aec709c9314ba5460254189",expect.originMainnet="4fce929af95eaae77fbb75520c5c6cc37a60b8809a8e30794aa54de85151cc5a_o1",expect.locationMainnet="4fce929af95eaae77fbb75520c5c6cc37a60b8809a8e30794aa54de85151cc5a_o1",expect.ownerMainnet="02ed21e46d53ca50b04dbb44d27db3e773602276178425ab6ed69743f82d7a3468",t.exports=expect},function(t,e){t.exports=require("vm")},function(t,e){t.exports=require("vm-browserify")},function(t,e,o){const{aabd:n}=o(8),util=o(3);t.exports=class{constructor(t){this.run=t,this.blockchain=t.blockchain,this.code=t.code,this.state=t.state,this.pay=(...e)=>t.purse.pay(...e),this.sign=(...e)=>t.owner.sign(...e),this.aaxc=[],this.aauc=[],this.aawc=new Map,this.aavc=new Set}aalb(t){for(const[e,o]of t.locations)this.aawc.has(e)||this.aawc.set(e,o);this.aaxc.push(t),1===this.aaxc.length&&this.aakb().catch(t=>{})}async aakb(){const t=this.aaxc[0];if(!t.actions.length&&!t.code.length)return this.aajb();const e=util.aas(this.blockchain.network);let n=null;try{const e=t.aapb(this.run),{refs:o,aahd:r,aaid:s}=e;n=e.tx;const i=o.map(t=>t.slice(0,64)),a=o.map(t=>parseInt(t.slice(66)));(i.length?await Promise.all(i.map(t=>this.blockchain.fetch(t))):[]).forEach((t,e)=>{if(void 0===t.outputs[a[e]].spentTxId)throw new Error(`Read ${o[e]} may not be latest. Blockchain did not return spentTxId. Aborting.`);if(null!==t.outputs[a[e]].spentTxId)throw new Error(`Read ${o[e]} is not the latest. Must sync() jigs`)}),t.imported||(n=await this.pay(n)),n=await this.sign(n);for(let t=0;t<r.length;t++)if(!n.inputs[t].isFullySigned())throw new Error(`Signature missing for ${r[t].constructor.name}\n\norigin: ${r[t].origin}\nlocation: ${s[t]}\nowner: ${r[t].owner}`);await this.broadcast(n),this.aavc.forEach(t=>t(n))}catch(t){const e=0===this.aauc.length;return e&&this.run.logger.error(`Unhandled ${t.toString()}`),this.aauc.forEach(e=>e.reject(t)),this.aauc=[],this.aaxc.forEach(o=>o.rollback(this.aawc,this.run,t,e)),this.aaxc=[],void(this.aawc=new Map)}const r=t=>this.aaxc.slice(1).some(e=>e.outputs.some(e=>util.aar(t,e)));t.outputs.forEach((e,o)=>{const s=1+t.code.length+o;"_"===e.origin[0]&&(e.origin=`${n.hash}_o${s}`),r(e)?this.aawc.set(e.origin,`${n.hash}_o${s}`):(e.location=`${n.hash}_o${s}`,this.aawc.delete(e.origin)),t.stateAfter.get(e).json.origin=e.origin,t.stateAfter.get(e).json.location=`${n.hash}_o${s}`}),t.code.forEach((t,e)=>t.success(`${n.hash}_o${e+1}`));for(const r of t.outputs){const s=t.stateAfter.get(r),i=util.aam(s.json,[util.aao(s.refs)]),{Jig:Jig}=o(1),a=util.aal(i,[t=>{if(util.aai(t)||t instanceof Jig){const e=this.aawc.get(t.origin)||t.location;return{$ref:e.startsWith(n.hash)?e.slice(64):e}}}]);a.origin.startsWith(n.hash)&&delete a.origin,a.location.startsWith(n.hash)&&delete a.location;let c=r.constructor[`origin${e}`];c.startsWith(n.hash)&&(c=c.slice(64));const u={type:c,state:a};await this.state.set(s.json.location,u)}t.code.forEach(t=>this.run.owner.aavb(t.sandbox)),t.outputs.forEach(e=>this.run.owner.aavb(t.aazb.get(e))),this.aajb()}async broadcast(t){try{await this.blockchain.broadcast(t)}catch(t){let e=`Broadcast failed, ${t.message}`;if(-1!==t.toString().indexOf("tx has no inputs")||-1!==t.toString().indexOf("tx fee too low")){e=`${e}\n\n${"Hint: Is the purse funded to pay for this transaction?"}`}throw new Error(e)}}async aajb(){this.aaxc.shift(),this.aaxc.length?this.aakb():(this.aauc.forEach(t=>t.resolve()),this.aauc=[])}async sync(t={}){const e=new Set,o=t=>e.add(t.hash);this.aavc.add(o);const n=async()=>t.target&&(void 0===t.forward||t.forward)?this.aaib(t.target,e).then(()=>t.target):t.target;if(!this.aaxc.length)return n();const r=new Promise((t,e)=>{this.aauc.push({resolve:t,reject:e})}),s=()=>this.aavc.delete(o);return r.then(()=>(s(),n())).catch(t=>(s(),(t=>n().then(()=>{throw t}).catch(e=>{throw t}))(t)))}async aaib(t,e=new Set,r=new Map){const s=r.get(t.origin);if(s)return this.code.aaad.aaac=!1,Object.assign(t,s),this.code.aaad.aaac=!0,t;let i=t.location.slice(0,64),a=parseInt(t.location.slice(66)),c=await this.blockchain.fetch(i,!e.has(i));for(e.add(i);;){const o=c.outputs[a];if(void 0===o.spentTxId){throw new Error(`${"Blockchain API does not support forward syncing."}\n\n${"To just publish pending transactions, use `jig.sync({ forward: false })`."}`)}if(null===o.spentTxId)break;c=await this.blockchain.fetch(o.spentTxId,!e.has(i));const r=new n;if(await r.import(c,this.run,t,!0),e.add(o.spentTxId),!Array.from(r.aazb.values()).some(e=>e===t))throw new Error("jig not found");i=t.location.slice(0,64),a=parseInt(t.location.slice(66))}r.set(t.origin,t);const u=new Set,{Jig:Jig}=o(1);this.code.aaad.aaac=!1,util.aap(t,(t,e,o)=>{t&&t instanceof Jig&&o&&u.add(t)}),this.code.aaad.aaac=!0;for(const t of u)await this.aaib(t,e,r)}}},function(t,e,o){const n=o(2),util=o(3);t.exports={Pay:class{async pay(t){throw new Error("not implemented")}},Purse:class{constructor(t={}){if(void 0===t.blockchain)throw new Error("purse blockchain option must be defined");const e=util.bsvNetwork(t.blockchain.network);this.bsvPrivateKey=new n.PrivateKey(t.privkey,e),this.privkey=this.bsvPrivateKey.toString(),this.bsvAddress=this.bsvPrivateKey.toAddress(),this.address=this.bsvAddress.toString(),this.blockchain=t.blockchain,this.logger=t.logger,this.splits=void 0===t.splits?10:t.splits}async pay(t){let e=await this.blockchain.utxos(this.address);if(!e.length){const e=`Hint: Have you funded the purse address ${this.address}?`;return this.logger&&this.logger.warn(`No purse utxos\n\n${e}`),t}if(e.length<this.splits){this.logger&&this.logger.info(`Splitting purse utxos into ${this.splits} pieces`);const t=e.reduce((t,e)=>t+e.satoshis,0),o=(new n.Transaction).from(e);for(let e=0;e<this.splits-1;e++)o.to(this.bsvAddress,Math.floor(t/this.splits));o.change(this.bsvAddress),o.sign(this.bsvPrivateKey),await this.blockchain.broadcast(o),e=await this.blockchain.utxos(this.address)}e=function(t){for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}(e);const o=()=>t.isFullySigned()?t.toBuffer().length:Math.max(1e3,t._estimateFee()+t._getOutputAmount());for(const n of e){if(t._getInputAmount()>=o())break;const e=await this.blockchain.fetch(n.txid);"other"===util.aag(e,n.vout)&&t.from(n)}if(t._getInputAmount()<o())throw new Error("not enough funds");return t.change(this.bsvAddress),t.sign(this.bsvPrivateKey),t}async balance(){return(await this.utxos()).reduce((t,e)=>t+e.satoshis,0)}async utxos(){const t=await this.blockchain.utxos(this.address),e=await Promise.all(t.map(t=>this.blockchain.fetch(t.txid)));return t.filter((t,o)=>"other"===util.aag(e[o],t.vout))}}}},function(t,e,o){const n=o(2),util=o(3);t.exports=class{constructor(t,e){const o=util.bsvNetwork(e.network);this.logger=e.logger,this.run=e.run,t=t||new n.PrivateKey(o);try{const e=new n.PrivateKey(t,o);if(e.toString()!==t.toString())throw new Error;return this.aaqb(e)}catch(t){if("Private key network mismatch"===t.message)throw t}try{return this.aarb(new n.PublicKey(t,{network:o}))}catch(t){}try{return this.aasb(new n.Address(t,o))}catch(t){if("Address has mismatched network type."===t.message)throw t}throw new Error(`bad owner key or address: ${t}`)}aaqb(t){return this.bsvPrivateKey=t,this.privkey=t.toString(),this.aarb(t.publicKey)}aarb(t){return this.bsvPublicKey=t,this.pubkey=t.toString(),this.aasb(t.toAddress())}aasb(t){return this.bsvAddress=t,this.address=t.toString(),this.refs=new Map,this}get jigs(){try{return Array.from(this.refs.values()).filter(t=>t instanceof this.run.constructor.Jig)}catch(t){return this.logger&&this.logger.error(`Bad token found in owner refs. Removing.\n\n${t}`),this.aaub(),this.jigs}}get code(){try{return Array.from(this.refs.values()).filter(t=>!(t instanceof this.run.constructor.Jig))}catch(t){return this.logger&&this.logger.error(`Bad token found in owner refs. Removing.\n\n${t}`),this.aaub(),this.code}}aaub(){let t=!0;const e=[];for(const[o,n]of this.refs)try{const e=n instanceof this.run.constructor.Jig;t=t?!e:e}catch(t){e.push(o)}e.forEach(t=>this.refs.delete(t))}async sign(t){return this.bsvPrivateKey&&t.sign(this.bsvPrivateKey),t}async sync(){return await this.run.aaqc.sync(),this._query||(this._query=new Promise((t,e)=>{this.aatb().then(()=>{this._query=null,t()}).catch(t=>{this._query=null,e(t)})})),this._query}async aatb(){const t=await this.run.blockchain.utxos(this.address),e=new Map,o=new Map;for(const[t,n]of this.refs){"string"!=typeof t&&e.set(t,n);try{o.set(n.location,n)}catch(t){}}for(const n of t){const t=`${n.txid}_o${n.vout}`,r=o.get(t);if(r)e.delete(r),e.set(t,r);else try{const o=await this.run.load(t);e.set(o.origin,o)}catch(e){this.logger&&this.logger.error(`Failed to load owner location ${t}\n\n${e.toString()}`)}}this.refs=e}aavb(t){this.refs.delete(t);try{if(t.owner===this.pubkey)try{if(void 0===t.origin)throw new Error;if(t.origin.startsWith("_"))throw new Error;this.refs.set(t.origin,t)}catch(e){this.refs.set(t,t)}else try{this.refs.delete(t.origin)}catch(t){}}catch(t){}}}},function(t,e,o){const{Address:n,Script:r,Transaction:s}=o(2),i=o(28),util=o(3);class a{constructor(t={}){var e;this.network=function(t){if("main"===t||"test"===t||"stn"===t)return t;switch(typeof t){case"string":throw new Error(`Unknown network: ${t}`);case"undefined":return"main";default:throw new Error(`Invalid network: ${t}`)}}(t.network),this.logger=function(t){switch(typeof t){case"object":return t;case"undefined":return null;default:throw new Error(`Invalid logger: ${t}`)}}(t.logger),this.api=function(t){switch(typeof t){case"string":{const e=d.find(e=>e.name===t);if(!e)throw new Error(`Unknown blockchain API: ${t}`);return e}case"object":if(!t)throw new Error(`Invalid blockchain API: ${t}`);return t;case"undefined":return d[0];default:throw new Error(`Invalid blockchain API: ${t}`)}}(t.api),this.cache=(e=t.cache)&&e instanceof u?e:new u,this.axios=i.create({timeout:c(t.timeout)}),this.bsvNetwork=util.bsvNetwork(this.network),this.aahc=new Map}async broadcast(t){if(0===t.inputs.length)throw new Error("tx has no inputs");if(0===t.outputs.length)throw new Error("tx has no outputs");if(t.getFee()<t.toBuffer().length)throw new Error("tx fee too low");if(!0!==t.verify())throw new Error(t.verify());if(!0!==t.isFullySigned())throw new Error("tx not fully signed");t.time=Date.now(),t.confirmations=0,t.outputs.forEach(t=>{t.spentTxId=null,t.spentIndex=null,t.spentHeight=null}),await this._post(this.api.aat(this.network),this.api.aau(t)),this.cache.aacb(t)}async fetch(t,e=!1){const o=this.cache.get(t);if(!e&&o)return o;const n=this.aahc.get(t);if(n)return new Promise((t,e)=>n.push({resolve:t,reject:e}));this.aahc.set(t,[]);try{const e=(await this._get(this.api.aav(this.network,t))).data,n=this.api.aaw(e);if(o)for(let t=0;t<n.outputs.length;t++)n.outputs[t].spentTxId=n.outputs[t].spentTxId||o.outputs[t].spentTxId,n.outputs[t].spentIndex=n.outputs[t].spentIndex||o.outputs[t].spentIndex,n.outputs[t].spentHeight=n.outputs[t].spentHeight||o.outputs[t].spentHeight;return this.cache.aabb(n),this.aahc.get(t).forEach(t=>t.resolve(n)),n}catch(e){throw this.aahc.get(t).forEach(t=>t.reject(e)),e}finally{this.aahc.delete(t)}}async utxos(t){t=new n(t,this.bsvNetwork).toString();const e=this.aahc.get(t);if(e)return new Promise((t,o)=>e.push({resolve:t,reject:o}));this.aahc.set(t,[]);try{const e=(await this._get(this.api.aax(this.network,t))).data,o=this.api.aay(e,t),n=this.aaz(o),r=this.cache.aaab(n,t);return this.aahc.get(t).forEach(t=>t.resolve(r)),r}catch(e){throw this.aahc.get(t).forEach(t=>t.reject(e)),e}finally{this.aahc.delete(t)}}aaz(t){const e=new Set;return t.filter(t=>{const o=`${t.txid}_o${t.vout}`;return e.has(o)?(this.logger&&this.logger.warn(`Duplicate utxo returned from server: ${o}`),!1):(e.add(o),!0)})}async _post(t,e){return this.logger&&this.logger.info(`POST ${t}`),h(this.axios.post(t,e))}async _get(t){return this.logger&&this.logger.info(`GET ${t}`),h(this.axios.get(t))}}function c(t){switch(typeof t){case"number":if(Number.isNaN(t)||t<0)throw new Error(`Invalid timeout: ${t}`);return t;case"undefined":return 1e4;default:throw new Error(`Invalid timeout: ${t}`)}}class u{constructor(){this.aanc=new Map,this.aaic=[],this.size=1e4,this.aajc=6e5,this.aakc=1e4}get(t){const e=this.aanc.get(t);if(e)return Date.now()-e.aalc>this.aajc?void this.aanc.delete(t):(this.aanc.delete(t),this.aanc.set(t,e),e)}aabb(t){if(t.aalc=Date.now(),this.aanc.set(t.hash,t),this.aanc.size>this.size){const t=this.aanc.keys().next().value;this.aanc.delete(t)}}aacb(t){this.aabb(t);const e=Date.now();this.aaic=this.aaic.filter(t=>e-t.time<this.aakc),this.aaic.push(t),t.inputs.forEach((e,o)=>{const n=this.aanc.get(e.prevTxId.toString("hex"));n&&(n.outputs[e.outputIndex].spentTxId=t.hash,n.outputs[e.outputIndex].spentIndex=o,n.outputs[e.outputIndex].spentHeight=-1)})}aaab(t,e){const o=Date.now();return this.aaic=this.aaic.filter(t=>o-t.time<this.aakc),this.aaic.forEach(o=>{o.outputs.forEach((n,r)=>{n.script.toAddress(this.bsvNetwork).toString()!==e||t.some(t=>t.txid===o.hash&&t.vout===r)||t.push({txid:o.hash,vout:r,script:n.script,satoshis:n.satoshis})})}),this.aaic.forEach(e=>{t=t.filter(t=>!e.inputs.some(e=>((t,e)=>t.prevTxId.toString("hex")===e.txid&&t.outputIndex===e.vout)(e,t)))}),t}}async function h(t){try{return await t}catch(t){const{config:e,response:o}=t;if(e&&e.url&&o&&o.data){const t=o.data.message?o.data.message.message||o.data.message:o.data,n=o.data.name&&t?`${o.data.name}: ${t}`:o.data.name||t;throw new Error(`${n}\n\n${e.method.toUpperCase()} ${e.url}`)}throw t}}function l(t){const e=new s(t.hex||t.rawtx);return e.time=1e3*t.time||Date.now(),t.blockhash&&t.blockhash.length&&(e.blockhash=t.blockhash),t.blocktime&&(e.blocktime=t.blocktime),t.blockheight&&(e.blockheight=t.blockheight),void 0!==t.confirmations&&(e.confirmations=t.confirmations),t.vout&&t.vout.forEach((t,o)=>{void 0!==t.spentTxId&&(e.outputs[o].spentTxId=t.spentTxId),void 0!==t.spentIndex&&(e.outputs[o].spentIndex=t.spentIndex),void 0!==t.spentHeight&&(e.outputs[o].spentHeight=t.spentHeight)}),e}const f="https://api.star.store",d=[{name:"star",aat:t=>`${f}/v1/${t}/tx`,aau:t=>({rawtx:t.toBuffer().toString("hex")}),aav:(t,e)=>`${f}/v1/${t}/tx/${e}`,aaw:t=>l(t),aax:(t,e)=>`${f}/v1/${t}/utxos/${e.toString()}`,aay:(t,e)=>t},{name:"bitindex",aat:t=>`https://api.bitindex.network/api/v3/${t}/tx/send`,aau:t=>({rawtx:t.toBuffer().toString("hex")}),aav:(t,e)=>`https://api.bitindex.network/api/v3/${t}/tx/${e}`,aaw:t=>{const e=l(t);return e.confirmations=e.confirmations||0,e},aax:(t,e)=>`https://api.bitindex.network/api/v3/${t}/addr/${e.toString()}/utxo`,aay:(t,e)=>t.map(t=>({...t,script:new r(t.scriptPubKey)}))},{name:"whatsonchain",aat:t=>`https://api.whatsonchain.com/v1/bsv/${t}/tx/raw`,aau:t=>({txhex:t.toBuffer().toString("hex")}),aav:(t,e)=>`https://api.whatsonchain.com/v1/bsv/${t}/tx/hash/${e}`,aaw:t=>{const e=l(t);return e.confirmations=e.confirmations||0,e},aax:(t,e)=>`https://api.whatsonchain.com/v1/bsv/${t}/address/${e.toString()}/unspent`,aay:(t,e)=>t.map(t=>({txid:t.tx_hash,vout:t.tx_pos,satoshis:t.value,script:r.fromAddress(e)}))}];a.Cache=u,t.exports={Blockchain:class{get network(){throw new Error("Not implemented")}async broadcast(t){throw new Error("not implemented")}async fetch(t,e){throw new Error("not implemented")}async utxos(t){throw new Error("not implemented")}},BlockchainServer:a}},function(t,e,o){t.exports=o(29)},function(t,e,o){"use strict";var n=o(0),r=o(9),s=o(31),i=o(19);function a(t){var e=new s(t),o=r(s.prototype.request,e);return n.extend(o,s.prototype,e),n.extend(o,e),o}var c=a(o(11));c.Axios=s,c.create=function(t){return a(i(c.defaults,t))},c.Cancel=o(20),c.CancelToken=o(56),c.isCancel=o(10),c.all=function(t){return Promise.all(t)},c.spread=o(57),t.exports=c,t.exports.default=c},function(t,e){t.exports=function(t){return null!=t&&null!=t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}},function(t,e,o){"use strict";var n=o(0),r=o(4),s=o(32),i=o(33),a=o(19);function c(t){this.defaults=t,this.interceptors={request:new s,response:new s}}c.prototype.request=function(t){"string"==typeof t?(t=arguments[1]||{}).url=arguments[0]:t=t||{},(t=a(this.defaults,t)).method=t.method?t.method.toLowerCase():"get";var e=[i,void 0],o=Promise.resolve(t);for(this.interceptors.request.forEach((function(t){e.unshift(t.fulfilled,t.rejected)})),this.interceptors.response.forEach((function(t){e.push(t.fulfilled,t.rejected)}));e.length;)o=o.then(e.shift(),e.shift());return o},c.prototype.getUri=function(t){return t=a(this.defaults,t),r(t.url,t.params,t.paramsSerializer).replace(/^\?/,"")},n.forEach(["delete","get","head","options"],(function(t){c.prototype[t]=function(e,o){return this.request(n.merge(o||{},{method:t,url:e}))}})),n.forEach(["post","put","patch"],(function(t){c.prototype[t]=function(e,o,r){return this.request(n.merge(r||{},{method:t,url:e,data:o}))}})),t.exports=c},function(t,e,o){"use strict";var n=o(0);function r(){this.handlers=[]}r.prototype.use=function(t,e){return this.handlers.push({fulfilled:t,rejected:e}),this.handlers.length-1},r.prototype.eject=function(t){this.handlers[t]&&(this.handlers[t]=null)},r.prototype.forEach=function(t){n.forEach(this.handlers,(function(e){null!==e&&t(e)}))},t.exports=r},function(t,e,o){"use strict";var n=o(0),r=o(34),s=o(10),i=o(11),a=o(54),c=o(55);function u(t){t.cancelToken&&t.cancelToken.throwIfRequested()}t.exports=function(t){return u(t),t.baseURL&&!a(t.url)&&(t.url=c(t.baseURL,t.url)),t.headers=t.headers||{},t.data=r(t.data,t.headers,t.transformRequest),t.headers=n.merge(t.headers.common||{},t.headers[t.method]||{},t.headers||{}),n.forEach(["delete","get","head","post","put","patch","common"],(function(e){delete t.headers[e]})),(t.adapter||i.adapter)(t).then((function(e){return u(t),e.data=r(e.data,e.headers,t.transformResponse),e}),(function(e){return s(e)||(u(t),e&&e.response&&(e.response.data=r(e.response.data,e.response.headers,t.transformResponse))),Promise.reject(e)}))}},function(t,e,o){"use strict";var n=o(0);t.exports=function(t,e,o){return n.forEach(o,(function(o){t=o(t,e)})),t}},function(t,e,o){"use strict";var n=o(0);t.exports=function(t,e){n.forEach(t,(function(o,n){n!==e&&n.toUpperCase()===e.toUpperCase()&&(t[e]=o,delete t[n])}))}},function(t,e,o){"use strict";var n=o(0),r=o(12),s=o(4),i=o(14),a=o(15),c=o(16).http,u=o(16).https,h=o(17),l=o(48),f=o(49),d=o(5),p=o(13),g=/https:?/;t.exports=function(t){return new Promise((function(e,o){var w,m=function(t){clearTimeout(w),e(t)},b=function(t){clearTimeout(w),o(t)},y=t.data,x=t.headers;if(x["User-Agent"]||x["user-agent"]||(x["User-Agent"]="axios/"+f.version),y&&!n.isStream(y)){if(Buffer.isBuffer(y));else if(n.isArrayBuffer(y))y=Buffer.from(new Uint8Array(y));else{if(!n.isString(y))return b(d("Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream",t));y=Buffer.from(y,"utf-8")}x["Content-Length"]=y.length}var v=void 0;t.auth&&(v=(t.auth.username||"")+":"+(t.auth.password||""));var E=h.parse(t.url),k=E.protocol||"http:";if(!v&&E.auth){var $=E.auth.split(":");v=($[0]||"")+":"+($[1]||"")}v&&delete x.Authorization;var O=g.test(k),C=O?t.httpsAgent:t.httpAgent,_={path:s(E.path,t.params,t.paramsSerializer).replace(/^\?/,""),method:t.method.toUpperCase(),headers:x,agent:C,auth:v};t.socketPath?_.socketPath=t.socketPath:(_.hostname=E.hostname,_.port=E.port);var T,j=t.proxy;if(!j&&!1!==j){var S=k.slice(0,-1)+"_proxy",A=process.env[S]||process.env[S.toUpperCase()];if(A){var R=h.parse(A),I=process.env.no_proxy||process.env.NO_PROXY,P=!0;if(I)P=!I.split(",").map((function(t){return t.trim()})).some((function(t){return!!t&&("*"===t||("."===t[0]&&E.hostname.substr(E.hostname.length-t.length)===t&&t.match(/\./g).length===E.hostname.match(/\./g).length||E.hostname===t))}));if(P&&(j={host:R.hostname,port:R.port},R.auth)){var B=R.auth.split(":");j.auth={username:B[0],password:B[1]}}}}if(j&&(_.hostname=j.host,_.host=j.host,_.headers.host=E.hostname+(E.port?":"+E.port:""),_.port=j.port,_.path=k+"//"+E.hostname+(E.port?":"+E.port:"")+_.path,j.auth)){var F=Buffer.from(j.auth.username+":"+j.auth.password,"utf8").toString("base64");_.headers["Proxy-Authorization"]="Basic "+F}var N=O&&(!j||g.test(j.protocol));t.transport?T=t.transport:0===t.maxRedirects?T=N?a:i:(t.maxRedirects&&(_.maxRedirects=t.maxRedirects),T=N?u:c),t.maxContentLength&&t.maxContentLength>-1&&(_.maxBodyLength=t.maxContentLength);var q=T.request(_,(function(e){if(!q.aborted){var o=e;switch(e.headers["content-encoding"]){case"gzip":case"compress":case"deflate":o=204===e.statusCode?o:o.pipe(l.createUnzip()),delete e.headers["content-encoding"]}var n=e.req||q,s={status:e.statusCode,statusText:e.statusMessage,headers:e.headers,config:t,request:n};if("stream"===t.responseType)s.data=o,r(m,b,s);else{var i=[];o.on("data",(function(e){i.push(e),t.maxContentLength>-1&&Buffer.concat(i).length>t.maxContentLength&&(o.destroy(),b(d("maxContentLength size of "+t.maxContentLength+" exceeded",t,null,n)))})),o.on("error",(function(e){q.aborted||b(p(e,t,null,n))})),o.on("end",(function(){var e=Buffer.concat(i);"arraybuffer"!==t.responseType&&(e=e.toString(t.responseEncoding)),s.data=e,r(m,b,s)}))}}}));q.on("error",(function(e){q.aborted||b(p(e,t,null,q))})),t.timeout&&(w=setTimeout((function(){q.abort(),b(d("timeout of "+t.timeout+"ms exceeded",t,"ECONNABORTED",q))}),t.timeout)),t.cancelToken&&t.cancelToken.promise.then((function(t){q.aborted||(q.abort(),b(t))})),n.isStream(y)?y.on("error",(function(e){b(p(e,t,null,q))})).pipe(q):q.end(y)}))}},function(t,e){t.exports=require("assert")},function(t,e){t.exports=require("stream")},function(t,e,o){"undefined"==typeof process||"renderer"===process.type?t.exports=o(40):t.exports=o(42)},function(t,e,o){function n(){var t;try{t=e.storage.debug}catch(t){}return!t&&"undefined"!=typeof process&&"env"in process&&(t=process.env.DEBUG),t}(e=t.exports=o(18)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},e.formatArgs=function(t){var o=this.useColors;if(t[0]=(o?"%c":"")+this.namespace+(o?" %c":" ")+t[0]+(o?"%c ":" ")+"+"+e.humanize(this.diff),!o)return;var n="color: "+this.color;t.splice(1,0,n,"color: inherit");var r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,(function(t){"%%"!==t&&(r++,"%c"===t&&(s=r))})),t.splice(s,0,n)},e.save=function(t){try{null==t?e.storage.removeItem("debug"):e.storage.debug=t}catch(t){}},e.load=n,e.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},e.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(t){}}(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.formatters.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}},e.enable(n())},function(t,e){var o=1e3,n=6e4,r=36e5,s=24*r;function i(t,e,o){if(!(t<e))return t<1.5*e?Math.floor(t/e)+" "+o:Math.ceil(t/e)+" "+o+"s"}t.exports=function(t,e){e=e||{};var a,c=typeof t;if("string"===c&&t.length>0)return function(t){if((t=String(t)).length>100)return;var e=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(t);if(!e)return;var i=parseFloat(e[1]);switch((e[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"days":case"day":case"d":return i*s;case"hours":case"hour":case"hrs":case"hr":case"h":return i*r;case"minutes":case"minute":case"mins":case"min":case"m":return i*n;case"seconds":case"second":case"secs":case"sec":case"s":return i*o;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(t);if("number"===c&&!1===isNaN(t))return e.long?i(a=t,s,"day")||i(a,r,"hour")||i(a,n,"minute")||i(a,o,"second")||a+" ms":function(t){if(t>=s)return Math.round(t/s)+"d";if(t>=r)return Math.round(t/r)+"h";if(t>=n)return Math.round(t/n)+"m";if(t>=o)return Math.round(t/o)+"s";return t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},function(t,e,o){var n=o(43),util=o(44);(e=t.exports=o(18)).init=function(t){t.inspectOpts={};for(var o=Object.keys(e.inspectOpts),n=0;n<o.length;n++)t.inspectOpts[o[n]]=e.inspectOpts[o[n]]},e.log=function(){return process.stderr.write(util.format.apply(util,arguments)+"\n")},e.formatArgs=function(t){var o=this.namespace;if(this.useColors){var n=this.color,r="[3"+(n<8?n:"8;5;"+n),s="  "+r+";1m"+o+" [0m";t[0]=s+t[0].split("\n").join("\n"+s),t.push(r+"m+"+e.humanize(this.diff)+"[0m")}else t[0]=(e.inspectOpts.hideDate?"":(new Date).toISOString()+" ")+o+" "+t[0]},e.save=function(t){null==t?delete process.env.DEBUG:process.env.DEBUG=t},e.load=s,e.useColors=function(){return"colors"in e.inspectOpts?Boolean(e.inspectOpts.colors):n.isatty(process.stderr.fd)},e.colors=[6,2,3,4,5,1];try{var r=o(45);r&&r.level>=2&&(e.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch(t){}function s(){return process.env.DEBUG}e.inspectOpts=Object.keys(process.env).filter((function(t){return/^debug_/i.test(t)})).reduce((function(t,e){var o=e.substring(6).toLowerCase().replace(/_([a-z])/g,(function(t,e){return e.toUpperCase()})),n=process.env[e];return n=!!/^(yes|on|true|enabled)$/i.test(n)||!/^(no|off|false|disabled)$/i.test(n)&&("null"===n?null:Number(n)),t[o]=n,t}),{}),e.formatters.o=function(t){return this.inspectOpts.colors=this.useColors,util.inspect(t,this.inspectOpts).split("\n").map((function(t){return t.trim()})).join(" ")},e.formatters.O=function(t){return this.inspectOpts.colors=this.useColors,util.inspect(t,this.inspectOpts)},e.enable(s())},function(t,e){t.exports=require("tty")},function(t,e){t.exports=require("util")},function(t,e,o){"use strict";const n=o(46),r=o(47),{env:s}=process;let i;function a(t){return function(t){return 0!==t&&{level:t,hasBasic:!0,has256:t>=2,has16m:t>=3}}(function(t){if(0===i)return 0;if(r("color=16m")||r("color=full")||r("color=truecolor"))return 3;if(r("color=256"))return 2;if(t&&!t.isTTY&&void 0===i)return 0;const e=i||0;if("dumb"===s.TERM)return e;if("win32"===process.platform){const t=n.release().split(".");return Number(process.versions.node.split(".")[0])>=8&&Number(t[0])>=10&&Number(t[2])>=10586?Number(t[2])>=14931?3:2:1}if("CI"in s)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI"].some(t=>t in s)||"codeship"===s.CI_NAME?1:e;if("TEAMCITY_VERSION"in s)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(s.TEAMCITY_VERSION)?1:0;if("truecolor"===s.COLORTERM)return 3;if("TERM_PROGRAM"in s){const t=parseInt((s.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(s.TERM_PROGRAM){case"iTerm.app":return t>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(s.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(s.TERM)?1:"COLORTERM"in s?1:e}(t))}r("no-color")||r("no-colors")||r("color=false")||r("color=never")?i=0:(r("color")||r("colors")||r("color=true")||r("color=always"))&&(i=1),"FORCE_COLOR"in s&&(i=!0===s.FORCE_COLOR||"true"===s.FORCE_COLOR?1:!1===s.FORCE_COLOR||"false"===s.FORCE_COLOR?0:0===s.FORCE_COLOR.length?1:Math.min(parseInt(s.FORCE_COLOR,10),3)),t.exports={supportsColor:a,stdout:a(process.stdout),stderr:a(process.stderr)}},function(t,e){t.exports=require("os")},function(t,e,o){"use strict";t.exports=(t,e)=>{e=e||process.argv;const o=t.startsWith("-")?"":1===t.length?"-":"--",n=e.indexOf(o+t),r=e.indexOf("--");return-1!==n&&(-1===r||n<r)}},function(t,e){t.exports=require("zlib")},function(t){t.exports=JSON.parse('{"_args":[["axios@0.19.0","/home/brenton/code/runonbitcoin/run"]],"_from":"axios@0.19.0","_id":"axios@0.19.0","_inBundle":false,"_integrity":"sha512-1uvKqKQta3KBxIz14F2v06AEHZ/dIoeKfbTRkK1E5oqjDnuEerLmYTgJB5AiQZHJcljpg1TuRzdjDR06qNk0DQ==","_location":"/axios","_phantomChildren":{},"_requested":{"type":"version","registry":true,"raw":"axios@0.19.0","name":"axios","escapedName":"axios","rawSpec":"0.19.0","saveSpec":null,"fetchSpec":"0.19.0"},"_requiredBy":["/"],"_resolved":"https://registry.npmjs.org/axios/-/axios-0.19.0.tgz","_spec":"0.19.0","_where":"/home/brenton/code/runonbitcoin/run","author":{"name":"Matt Zabriskie"},"browser":{"./lib/adapters/http.js":"./lib/adapters/xhr.js"},"bugs":{"url":"https://github.com/axios/axios/issues"},"bundlesize":[{"path":"./dist/axios.min.js","threshold":"5kB"}],"dependencies":{"follow-redirects":"1.5.10","is-buffer":"^2.0.2"},"description":"Promise based HTTP client for the browser and node.js","devDependencies":{"bundlesize":"^0.17.0","coveralls":"^3.0.0","es6-promise":"^4.2.4","grunt":"^1.0.2","grunt-banner":"^0.6.0","grunt-cli":"^1.2.0","grunt-contrib-clean":"^1.1.0","grunt-contrib-watch":"^1.0.0","grunt-eslint":"^20.1.0","grunt-karma":"^2.0.0","grunt-mocha-test":"^0.13.3","grunt-ts":"^6.0.0-beta.19","grunt-webpack":"^1.0.18","istanbul-instrumenter-loader":"^1.0.0","jasmine-core":"^2.4.1","karma":"^1.3.0","karma-chrome-launcher":"^2.2.0","karma-coverage":"^1.1.1","karma-firefox-launcher":"^1.1.0","karma-jasmine":"^1.1.1","karma-jasmine-ajax":"^0.1.13","karma-opera-launcher":"^1.0.0","karma-safari-launcher":"^1.0.0","karma-sauce-launcher":"^1.2.0","karma-sinon":"^1.0.5","karma-sourcemap-loader":"^0.3.7","karma-webpack":"^1.7.0","load-grunt-tasks":"^3.5.2","minimist":"^1.2.0","mocha":"^5.2.0","sinon":"^4.5.0","typescript":"^2.8.1","url-search-params":"^0.10.0","webpack":"^1.13.1","webpack-dev-server":"^1.14.1"},"homepage":"https://github.com/axios/axios","keywords":["xhr","http","ajax","promise","node"],"license":"MIT","main":"index.js","name":"axios","repository":{"type":"git","url":"git+https://github.com/axios/axios.git"},"scripts":{"build":"NODE_ENV=production grunt build","coveralls":"cat coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js","examples":"node ./examples/server.js","fix":"eslint --fix lib/**/*.js","postversion":"git push && git push --tags","preversion":"npm test","start":"node ./sandbox/server.js","test":"grunt test && bundlesize","version":"npm run build && grunt version && git add -A dist && git add CHANGELOG.md bower.json package.json"},"typings":"./index.d.ts","version":"0.19.0"}')},function(t,e,o){"use strict";var n=o(0),r=o(12),s=o(4),i=o(51),a=o(52),c=o(5);t.exports=function(t){return new Promise((function(e,u){var h=t.data,l=t.headers;n.isFormData(h)&&delete l["Content-Type"];var f=new XMLHttpRequest;if(t.auth){var d=t.auth.username||"",p=t.auth.password||"";l.Authorization="Basic "+btoa(d+":"+p)}if(f.open(t.method.toUpperCase(),s(t.url,t.params,t.paramsSerializer),!0),f.timeout=t.timeout,f.onreadystatechange=function(){if(f&&4===f.readyState&&(0!==f.status||f.responseURL&&0===f.responseURL.indexOf("file:"))){var o="getAllResponseHeaders"in f?i(f.getAllResponseHeaders()):null,n={data:t.responseType&&"text"!==t.responseType?f.response:f.responseText,status:f.status,statusText:f.statusText,headers:o,config:t,request:f};r(e,u,n),f=null}},f.onabort=function(){f&&(u(c("Request aborted",t,"ECONNABORTED",f)),f=null)},f.onerror=function(){u(c("Network Error",t,null,f)),f=null},f.ontimeout=function(){u(c("timeout of "+t.timeout+"ms exceeded",t,"ECONNABORTED",f)),f=null},n.isStandardBrowserEnv()){var g=o(53),w=(t.withCredentials||a(t.url))&&t.xsrfCookieName?g.read(t.xsrfCookieName):void 0;w&&(l[t.xsrfHeaderName]=w)}if("setRequestHeader"in f&&n.forEach(l,(function(t,e){void 0===h&&"content-type"===e.toLowerCase()?delete l[e]:f.setRequestHeader(e,t)})),t.withCredentials&&(f.withCredentials=!0),t.responseType)try{f.responseType=t.responseType}catch(e){if("json"!==t.responseType)throw e}"function"==typeof t.onDownloadProgress&&f.addEventListener("progress",t.onDownloadProgress),"function"==typeof t.onUploadProgress&&f.upload&&f.upload.addEventListener("progress",t.onUploadProgress),t.cancelToken&&t.cancelToken.promise.then((function(t){f&&(f.abort(),u(t),f=null)})),void 0===h&&(h=null),f.send(h)}))}},function(t,e,o){"use strict";var n=o(0),r=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];t.exports=function(t){var e,o,s,i={};return t?(n.forEach(t.split("\n"),(function(t){if(s=t.indexOf(":"),e=n.trim(t.substr(0,s)).toLowerCase(),o=n.trim(t.substr(s+1)),e){if(i[e]&&r.indexOf(e)>=0)return;i[e]="set-cookie"===e?(i[e]?i[e]:[]).concat([o]):i[e]?i[e]+", "+o:o}})),i):i}},function(t,e,o){"use strict";var n=o(0);t.exports=n.isStandardBrowserEnv()?function(){var t,e=/(msie|trident)/i.test(navigator.userAgent),o=document.createElement("a");function r(t){var n=t;return e&&(o.setAttribute("href",n),n=o.href),o.setAttribute("href",n),{href:o.href,protocol:o.protocol?o.protocol.replace(/:$/,""):"",host:o.host,search:o.search?o.search.replace(/^\?/,""):"",hash:o.hash?o.hash.replace(/^#/,""):"",hostname:o.hostname,port:o.port,pathname:"/"===o.pathname.charAt(0)?o.pathname:"/"+o.pathname}}return t=r(window.location.href),function(e){var o=n.isString(e)?r(e):e;return o.protocol===t.protocol&&o.host===t.host}}():function(){return!0}},function(t,e,o){"use strict";var n=o(0);t.exports=n.isStandardBrowserEnv()?{write:function(t,e,o,r,s,i){var a=[];a.push(t+"="+encodeURIComponent(e)),n.isNumber(o)&&a.push("expires="+new Date(o).toGMTString()),n.isString(r)&&a.push("path="+r),n.isString(s)&&a.push("domain="+s),!0===i&&a.push("secure"),document.cookie=a.join("; ")},read:function(t){var e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}}},function(t,e,o){"use strict";t.exports=function(t){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(t)}},function(t,e,o){"use strict";t.exports=function(t,e){return e?t.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):t}},function(t,e,o){"use strict";var n=o(20);function r(t){if("function"!=typeof t)throw new TypeError("executor must be a function.");var e;this.promise=new Promise((function(t){e=t}));var o=this;t((function(t){o.reason||(o.reason=new n(t),e(o.reason))}))}r.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},r.source=function(){var t;return{token:new r((function(e){t=e})),cancel:t}},t.exports=r},function(t,e,o){"use strict";t.exports=function(t){return function(e){return t.apply(null,e)}}},function(t,e,o){const{Address:n,Transaction:r}=o(2);t.exports=class{constructor(){this.network="mock",this.aanc=new Map,this.aamc=[],this.aaoc=-1}async broadcast(t){if(0===t.inputs.length)throw new Error("tx has no inputs");if(0===t.outputs.length)throw new Error("tx has no outputs");if(t.getFee()<t.toBuffer().length)throw new Error("tx fee too low");if(!0!==t.verify())throw new Error(t.verify());if(!0!==t.isFullySigned())throw new Error("tx not fully signed");let e=this.aamc.slice(0);const o=t=>e=>e.txid===t.prevTxId.toString("hex")&&e.vout===t.outputIndex;if(t.inputs.forEach((t,n)=>{if(!e.some(o(t)))throw new Error(`tx input ${n} missing or spent`);e=e.filter(e=>!o(t)(e))}),t.unconfirmedHeight=Math.max(...t.inputs.map(t=>this.aanc.get(t.prevTxId.toString("hex")).unconfirmedHeight+1)),t.unconfirmedHeight>25){throw new Error(`too-long-mempool-chain\n\n${"Hint: Use run.blockchain.block() to produce blocks on the mockchain."}`)}this.aamc=this.aamc.filter(e=>!t.inputs.some(t=>o(t)(e))),t.time=t.time||Date.now(),t.aaoc=-1,t.confirmations=0,this.aanc.set(t.hash,t),t.outputs.forEach(t=>{t.spentTxId=null,t.spentIndex=null,t.spentHeight=null}),t.inputs.forEach((e,o)=>{const n=this.aanc.get(e.prevTxId.toString("hex")).outputs[e.outputIndex];n.spentTxId=t.hash,n.spentIndex=o,n.spentHeight=-1}),t.outputs.forEach((e,o)=>this.aamc.push({txid:t.hash,vout:o,script:e.script,satoshis:e.satoshis}))}async fetch(t,e=!1){const o=this.aanc.get(t);if(o)return o;throw new Error(`tx not found: ${t}`)}async utxos(t){const e=new n(t,"testnet").toString();return this.aamc.filter(t=>t.script.toAddress("testnet").toString()===e)}fund(t,e){const o=Math.random().toString(),s=(new r).addData(o).to(new n(t,"testnet"),e);s.time=Date.now(),s.confirmations=0,s.aaoc=-1,s.unconfirmedHeight=0,this.aanc.set(s.hash,s);const i=s.outputs[1];this.aamc.push({txid:s.hash,vout:1,script:i.script,satoshis:i.satoshis})}block(){this.aaoc+=1;for(const t of this.aanc.values())if(-1===t.aaoc){t.aaoc=this.aaoc,t.unconfirmedHeight=0;for(const e of t.inputs){this.aanc.get(e.prevTxId.toString("hex")).outputs[e.outputIndex].spentHeight=this.aaoc}}}}},function(t,e){class o{constructor(t={}){this.cache=new Map,this.aayc=0;const e=void 0===t.maxSizeMB?10:t.maxSizeMB;this.aazc=Math.floor(1e3*e*1e3)}async get(t){const e=this.cache.get(t);if(e)return this.set(t,e),e}async set(t,e){const n=this.cache.get(t);if(n){if(JSON.stringify(e)!==JSON.stringify(n)){throw new Error(`Attempt to set different states for the same location: ${t}\n\n${"This is an internal Run bug. Please report it to the library developers."}`)}this.cache.delete(t)}if(this.cache.set(t,e),!n)for(this.aayc+=o.aawb(e);this.aayc>this.aazc;){const t=this.cache.keys().next().value,e=this.cache.get(t);this.cache.delete(t),this.aayc-=o.aawb(e)}}clear(){this.cache.clear(),this.aayc=0}static aawb(t){switch(typeof t){case"boolean":return 5;case"number":return 9;case"string":return 2*t.length+1;case"object":{if(!t)return 5;const e=Object.keys(t);let n=1+4*e.length;return e.forEach(e=>{n+=o.aawb(e),n+=o.aawb(t[e])}),n}default:return 5}}}t.exports={State:class{async get(t){throw new Error("not implemented")}async set(t,e){throw new Error("not implemented")}},StateCache:o}},function(t,e,o){const{Jig:Jig}=o(1),expect=o(21);class Token extends Jig{init(t,e,o){if(expect(this.constructor).not.toBe(Token,"Token must be extended"),void 0!==e)return expect(e).toBeObject("bad token type"),expect(e.constructor).toBe(this.constructor,"bad token class"),this._checkAmount(t),e._decreaseAmount(t),void(this.amount=t);if(void 0!==o){if(expect(o).toBeArray(),expect(o.length).toBeGreaterThanOrEqualTo(2,"must combine at least two tokens"),o.some(t=>t.constructor!==this.constructor))throw new Error("cannot combine different token classes");const t=t=>o.reduce((e,o)=>o===t?e+1:e,0);if(o.some(e=>t(e)>1))throw new Error("cannot combine duplicate tokens");return this.amount=0,o.forEach(t=>{this.amount+=t.amount,t._destroy()}),void this._checkAmount(this.amount)}this._checkAmount(t),expect(this.owner).toBe(this.constructor.owner,`Only ${this.constructor.name}'s owner may mint`),this.amount=t,this._onMint(t,caller)}send(t,e){if(e=void 0===e?this.amount:e,this._checkAmount(e),expect(e).toBeLessThanOrEqualTo(this.amount,"not enough funds"),this.amount===e)return this.owner=t,null;const o=new this.constructor(this.amount-e,this);return this.owner=t,o}get value(){let t=this.amount;for(let e=0;e<this.constructor.decimals;e++)t/=10;return t}static combine(...t){return new this(void 0,void 0,t)}_destroy(){this.amount=0,this.owner="029d11c250cc84a6ffbaf84fc28da82fc4deee214021bed2dcaa22d5193d22e273"}_decreaseAmount(t){this.amount-=t}_checkAmount(t){expect(t).toBeNumber("amount is not a number"),expect(t).toBeInteger("amount must be an integer"),expect(t).toBeGreaterThan(0,"amount must be positive"),expect(t).toBeLessThanOrEqualTo(Number.MAX_SAFE_INTEGER,"amount too large")}_onMint(t,e){}}Token.decimals=0,Token.deps={expect:expect},Token.originTestnet="745a40d575543d7f6edfcf9fb2bbab8afe73626effad7d58bd39096bc257e1a4_o1",Token.locationTestnet="745a40d575543d7f6edfcf9fb2bbab8afe73626effad7d58bd39096bc257e1a4_o1",Token.ownerTestnet="02749f92ba405487340ebba1cfa54925e64fcb5728cbd384f0a5dda43f9c2a73eb",Token.originMainnet="d92d2608c297fb7455c7f33d99a1cc7b48f91ffcb5b62595e249cf1e33fbbf43_o1",Token.locationMainnet="d92d2608c297fb7455c7f33d99a1cc7b48f91ffcb5b62595e249cf1e33fbbf43_o1",Token.ownerMainnet="031821479809d3b0b6271ada846e6b9ead2f350b9373a39e4f61db4a721f8aa855",t.exports=Token}]);